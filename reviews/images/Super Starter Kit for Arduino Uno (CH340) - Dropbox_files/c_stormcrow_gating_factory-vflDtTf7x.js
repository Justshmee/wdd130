define(["exports","./c_react_query_helpers_helpers","./c_api_v2_noauth_client","./c_stormcrow_types_log_exposure","./c_src_sink_index","./e_folder_viewer_src_main"],(function(t,e,n,a,r,s){"use strict";function o(t){return t.ns("stormcrow_servicer")}function i(t,e,n){r.getMetricsReporter().createStats({ns:"web_stormcrow",name:"stormcrow_exposure"},{feature:t,variant:e,client_log_status:n}).record(1)}class u{constructor(t,e){this.userApiV2Client=t,this.noAuthAPIV2Client=e}getVariant(t,e){const n=this.mapToAPIV2GetAssignmentsRequest(t);let a;return a=e?o(this.userApiV2Client).rpc("get_assignments",n,{subjectUserId:e}):o(this.noAuthAPIV2Client).rpc("get_assignments",n,{}),a.then((t=>this.mapToGetVariantResult(t)))}legacyLogExposure(t,e,n){var r;const s=this.mapToAPIV2LogExposuresRequest(t,e);let u;u=n?o(this.userApiV2Client).rpc("log_exposures",s,{subjectUserId:n}):o(this.noAuthAPIV2Client).rpc("log_exposures",s,{});const l=null!==(r=t.stormcrowVariantInfo)&&void 0!==r?r:t.growthbookVariantInfo,c=l.feature?l.feature:"unknown",g=l.variant?l.variant:"unknown";return u.then((t=>(i(c,g,a.ClientLogStatus.LOG_SUCCESS),this.mapToLogExposureResult(t)))).catch((t=>{throw i(c,g,a.ClientLogStatus.LOG_FAILURE),t}))}mapToLogExposureResult(t){return{status:t.status}}mapToGetVariantResult(t){if(t.assignments){return{variantInfos:t.assignments.map((t=>({feature:t.feature,variant:t.variant,metadata:t.metadata,status:t.status})))}}return null}mapToAPIV2GetAssignmentsRequest(t){return{request_params:{request_ip:t.request_ip,locales:t.locales,user_agent:t.user_agent},features:t.features.map((t=>({feature:t})))}}mapToAPIV2LogExposuresRequest(t,e){var n;e||(e=Date.now());const a=null!==(n=t.stormcrowVariantInfo)&&void 0!==n?n:t.growthbookVariantInfo;return{exposures:[{feature:a.feature,variant:a.variant,metadata:a.metadata,timestamp:e}]}}}class l extends u{logExposure(t){this.createAndLogPAPEvent(t)}createAndLogPAPEvent({stormcrowVariantInfo:t,growthbookVariantInfo:e}){var n,a,r,o,i;const u=null!=t?t:e,l=null===(a=null===(n=u.metadata)||void 0===n?void 0:n.metadata)||void 0===a?void 0:a.population_id,c=null===(o=null===(r=u.metadata)||void 0===r?void 0:r.metadata)||void 0===o?void 0:o.identity_gid,g=null===(i=u.metadata)||void 0===i?void 0:i.metadata;let p;null!=g&&(p=JSON.stringify(g)),function(t,e,n,a,r){s.UDCL.logEvent(s.PAP_Exposure_Stormcrow({feature:t,experimentVariant:e,populationId:n,identityGid:a,stormcrowMetadataJson:r}),{tags:t&&e?{feature:t,variant:e}:void 0})}(u.feature,u.variant,l,c,p)}}class c{constructor(t,e){this.userApiV2Client=t,this.noAuthAPIV2Client=e}getGatingClient(){return new l(this.userApiV2Client,this.noAuthAPIV2Client)}}let g,p;function _(){if(!g){const t=new e.UserApiV2Client,a=new n.NoAuthApiV2Client;g=new c(t,a)}return p||(p=g.getGatingClient()),p}var m=Object.freeze({__proto__:null,GatingFactory:c,getGatingClientSingleton:_});t.GatingFactory=c,t.StormcrowGatingClient=u,t.gating_factory_esnext=m,t.getGatingClientSingleton=_}));
//# sourceMappingURL=c_stormcrow_gating_factory.js-vflw72nkE.map
