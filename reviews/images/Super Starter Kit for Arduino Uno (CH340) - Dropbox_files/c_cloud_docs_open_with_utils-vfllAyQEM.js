define(["require","exports","./c_init_data_runtime","./c_cloud_docs_types","./c_apex-metrics_src_types","./e_folder_viewer_src_main","./c_cloud_docs_constants","./c_react_query_helpers_helpers","./c_api_v2_client_base","./c_core_uri","./e_core_exception","./c_referrer_cleansing_redirect","./c_hooks_use_stabilized_callback","./c_src_sink_index"],(function(e,o,t,r,i,n,c,s,d,_,u,a,l,p){"use strict";function f(e){let o="";return e.hasOwnProperty("ext")?o=e.ext:e.hasOwnProperty("filename")?(o=n.file_extension(e.filename),o&&(o="."+o)):(o=n.file_extension(e),o&&(o="."+o)),o}function E(e){const o=r.GetCloudDocsRoutes(new s.UserApiV2Client);let t;e.hasOwnProperty("docPathOrId")&&e.docPathOrId&&(t={".tag":"path_or_id",path_or_id:e.docPathOrId});const i=e.data&&e.data.webOpenId,n=e.data&&e.data.origDest,c=e.data&&e.data.routingDest;o.rpc("log_user_action",{action:e.actionEvent,doc_id:t,source:e.actionSource,open_id:i,orig_dest:n,routing_dest:c,extra_info:e.extra},{subjectUserId:e.userId})}let O;const S=[{id:"word",icon:"word",name:"Word for the web",exts:["odt","docm","docx"],sizeLimitBytes:104857600,editor:c.MicrosoftEditors.WORD},{id:"excel",icon:"excel",name:"Excel for the web",exts:["ods","xlsb","xlsm","xlsx"],sizeLimitBytes:104857600,editor:c.MicrosoftEditors.EXCEL},{id:"powerpoint",icon:"powerpoint",name:"PowerPoint for the web",exts:["odp","ppsx","pptx"],sizeLimitBytes:2147483648,editor:c.MicrosoftEditors.POWERPOINT}];class h{static initClass(){this.PRELOAD_URLS={},O=["com.adobe.Reader","Acrord32.exe","com.adobe.Acrobat","Acrobat.exe"]}static is_adobe_app(e){return Array.from(O).includes(e)}static getWopiOpenWithButtonInfo(e){let o;o=e.fq_path?e.fq_path:e.filename?e.filename:"";const t=n.file_extension(o);for(const e of S)if(-1!==e.exts.indexOf(t))return e;return null}}h.initClass();const w=()=>n.open_tab(c.LOADING_PAGE_URL,!0);let g;const y=(o,i)=>t.__awaiter(void 0,void 0,void 0,(function*(){return(yield function(){return t.__awaiter(this,void 0,void 0,(function*(){const{UserApiV2Client:o}=yield new Promise((function(o,t){e(["./c_react_query_helpers_helpers"],o,t)})).then((function(e){return e.user_client_esnext}));return r.GetCloudDocsRoutes(new o)}))}()).rpc("get_cloud_editor_url",{file_id:i},{subjectUserId:o})}));function T(e){!function(e){if(void 0!==e&&void 0!==e.error&&void 0!==e.error[".tag"])e.error[".tag"]}(e)}function P(e,o,t,i,c,s,d){const u=l.generateUUID("web_open_id"),a=_.URI.parse(e.cloud_editor_url).updateQuery({cloud_editor:c,web_open_id:u});s&&a.updateQuery({ignore_lock:"1"});const p=a.toString();p&&(void 0===d&&(d=r.UserActionSourceType.WEB),E({actionEvent:r.UserActionEventType.PRE_OPEN,userId:i,docPathOrId:t,actionSource:d,data:{webOpenId:u}}),null!=o?n.redirect(p,o):n.open_tab(p))}const m=e=>({fileId:e.file_id,openToUrl:e.open_to_url}),U=({fileId:e,openToUrl:o},r,n,s,d)=>t.__awaiter(void 0,void 0,void 0,(function*(){try{const _=performance.now(),u=p.getMetricsReporter(),a={};try{a.editor=n,d&&(a.source=d[".tag"]);const c=(()=>{let e=!1;if(i.edge||i.msie||i.edgeChromium())try{e=window.self!==window.top}catch(o){e=!0}return e})();if(a.isInEdgeIframe=String(c),o&&o.startsWith("https://www.dropbox.com/scl/fi/")){a.usedOpenToURLFromFile="true";P({cloud_editor_url:o},null,e,r,n,s,d)}else{a.usedOpenToURLFromFile="false";const o=c?null:w();P(c?yield((e,o)=>t.__awaiter(void 0,void 0,void 0,(function*(){return g||(g=y(e,o)),g})))(r,e):yield y(r,e),o,e,r,n,s,d)}a.error="false"}catch(e){a.error="true",T(e)}finally{u.createStats({ns:c.CLOUD_DOCS_AMP_NAMESPACE,name:"web/openWithCloudEditor"},a).recordDuration(performance.now()-_,i.TimeUnit.MILLISECONDS)}}catch(e){T(e)}}));var W;o.OpenWithCloudDocProvider=void 0,(W=o.OpenWithCloudDocProvider||(o.OpenWithCloudDocProvider={})).OfficeOnline="OfficeOnline",W.GoogleDSS="GoogleDSS";const x=(e,t,r)=>{const i=function(e,o){const t=f(e);for(const e of Object.keys(c.DSS_TYPE_TO_SUPPORTED_EXTS)){const o=e;if(c.DSS_TYPE_TO_SUPPORTED_EXTS[o].indexOf(t)>=0)return o}switch(t){case".gdoc":return c.GoogleFileTypes.GOOGLE_DSS_DOC;case".gsheet":return c.GoogleFileTypes.GOOGLE_DSS_SHEET;case".gslides":return c.GoogleFileTypes.GOOGLE_DSS_SLIDES}return null}(e);return i?{text:c.DSS_TYPE_TO_TEXT[i],iconUrl:c.DSS_TYPE_TO_OPEN_WITH_ICONS[i],handler:()=>U(m(e),t.id,i,!1,r),provider:o.OpenWithCloudDocProvider.GoogleDSS}:null},A=(e,t,r)=>{const i=h.getWopiOpenWithButtonInfo(e);return i?{text:i.name,spriteName:i.icon,handler:()=>U(m(e),t.id,i.editor,!1,r),provider:o.OpenWithCloudDocProvider.OfficeOnline}:null};o.OpenWith=h,o.createPlaceholderTabForNewCloudDoc=w,o.fileToOpenWithParams=m,o.getActionSourceFromNewFileMenuType=e=>{switch(e){case c.NewFileMenuFromType.BROWSE:return r.UserActionSourceType.WEB_BROWSE;case c.NewFileMenuFromType.HOME:return r.UserActionSourceType.WEB_HOME;default:return r.UserActionSourceType.WEB}},o.getActionSourceFromSourceArgs=e=>e.fileViewOrigin===n.FileViewOriginType.SEARCH?r.UserActionSourceType.WEB_SEARCH:e.fileViewOrigin===n.FileViewOriginType.BROWSE?r.UserActionSourceType.WEB_BROWSE:e.fileViewOrigin===n.FileViewOriginType.HOME?r.UserActionSourceType.WEB_HOME:r.UserActionSourceType.WEB,o.getActionSourceFromSurface=e=>"search"===e?r.UserActionSourceType.WEB_SEARCH:"previews"===e?r.UserActionSourceType.WEB_PREVIEW:"home_recent"===e||"home_starred"===e?r.UserActionSourceType.WEB_HOME:"browse"===e||"sidebar"===e?r.UserActionSourceType.WEB_BROWSE:r.UserActionSourceType.WEB,o.getCloudEditorUrl=y,o.getFileExt=f,o.getOpenWithCloudEditorInfo=(e,o,t,r)=>{const i=[],n=A(e,o,r);n&&t.wopi&&i.push(n);const c=x(e,o,r);return c&&t.gdd&&i.push(c),i},o.handleError=T,o.isCloudBasedDoc=function(e){return!!function(e){return[".gdoc",".gsheet",".gslides"].indexOf(f(e))>=0}(e)||!!function(e){return".web"===f(e)}(e)},o.logUserAction=E,o.openCloudDoc=(o,t,i)=>{if(i||(i=r.UserActionSourceType.WEB),o.href)if(c.isPointerByExtension(o.ns_path))a.safe_open_tab_and_redirect(o.href),E({actionEvent:r.UserActionEventType.PRE_OPEN,userId:t.id,docPathOrId:o.file_id,actionSource:i});else{const e=l.generateUUID("web_open_id"),c=_.URI.parse(o.href).updateQuery("web_open_id",e).toString();n.open_tab(c),E({actionEvent:r.UserActionEventType.PRE_OPEN,userId:t.id,docPathOrId:o.file_id,actionSource:i,data:{webOpenId:e}})}else{const r=w();new Promise((function(o,t){e(["./e_folder_viewer_src_main"],o,t)})).then((function(e){return e.actions_esnext$1})).then((e=>e.fetchPreviewUrl(o,t))).then((e=>{e&&null!==r&&a.redirect(e,r,!0)}))}},o.openCloudEditorUrl=P,o.openWithCloudEditor=U}));
//# sourceMappingURL=c_cloud_docs_open_with_utils.js-vflendA0D.map
