define(["exports","./c_src_sink_index","./e_folder_viewer_src_main","./c_init_data_runtime","./c_api_v2_client_base","./e_core_exception"],(function(e,t,i,n,a,s){"use strict";window.ensemble&&!window.ensemble.eventEmitter&&(window.ensemble.eventEmitter=new t.EventEmitter);const r=window.ensemble&&window.ensemble.eventEmitter?window.ensemble.eventEmitter:new t.EventEmitter;const o=new class{constructor(){this.controllerReady=!1,this.eventQueue=[],this.stepCallback={},this.globalCallbacks=[],this.on(i.UEStateChannel,this.handleUpdate,this)}init(){this._sendEvent({containerName:"UEClient",name:i.UEEventName.Subscribe,data:{}})}on(e,t,i){r.on(e,t,i)}removeListener(e,t,i){r.removeListener(e,t,i)}send(e,t){this._isUserEducationDisabled()||r.emit(e,t)}sendEvent(e,t,i={}){if(this._isUserEducationDisabled())return;const n={containerName:e,name:t,data:i};this.controllerReady?this._sendEvent(n):this.eventQueue.push(n)}_sendEvent(e){this._isUserEducationDisabled()||(this._shouldSendEventAsynchronously()?setTimeout((()=>this.send(i.UEEventChannel,e)),0):this.send(i.UEEventChannel,e))}_isUserEducationDisabled(){return!window.ensemble}_shouldSendEventAsynchronously(){return!0}_registerCallbackForEducationStep(e,t,i){const n=this._getKeyForStepCallback(e,t);this.stepCallback[n]||(this.stepCallback[n]=[]),this.stepCallback[n].push(i)}registerCallbackForEducationStep(e,t,n){this._registerCallbackForEducationStep(e,t,n),this.sendEvent("UEClientCallback",i.UEEventName.Subscribe)}registerBulkCallbackForEducationStep(e,t){e.forEach((e=>{this._registerCallbackForEducationStep(e.moduleName,e.stepName,t)})),this.sendEvent("UEClientCallback",i.UEEventName.Subscribe)}registerForAllEducationSteps(e){this.globalCallbacks.push(e),this.sendEvent("UEClientCallback",i.UEEventName.Subscribe)}unregisterCallbackForEducationStep(e,t,i){this.unregisterBulkCallbackForEducationStep([{moduleName:e,stepName:t}],i)}unregisterBulkCallbackForEducationStep(e,t){e.forEach((e=>{const i=this._getKeyForStepCallback(e.moduleName,e.stepName);if(this.stepCallback[i]){-1!==this.stepCallback[i].indexOf(t)&&(this.stepCallback[i].splice(this.stepCallback[i].indexOf(t),1),0===this.stepCallback[i].length&&delete this.stepCallback[i])}}))}unregisterForAllEducationSteps(e){const t=this.globalCallbacks.indexOf(e);-1!==t&&this.globalCallbacks.splice(t,1)}_getKeyForStepCallback(e,t){return`${e}.${t}`}handleUpdate(e){if(e.state!==i.UEStateType.Ready||this.controllerReady){if(e.state===i.UEStateType.ShowStep&&e.step&&e.step.name){const t=this._getKeyForStepCallback(e.moduleName,e.step.name);if(this.stepCallback[t]){for(const e of this.stepCallback[t])e();delete this.stepCallback[t]}for(const t of this.globalCallbacks)t(e)}}else for(this.controllerReady=!0;this.eventQueue.length>0;){const e=this.eventQueue.shift();e&&this._sendEvent(e)}}sendError(e){this.send(i.UEErrorChannel,e)}};o.init();function l(e){const t=a.getNetworkIdleObservable();let i,n=t.isIdle();const s=e=>{n="IDLE"===e,n?(e=>{var t;(null!==(t=window.requestIdleCallback)&&void 0!==t?t:window.setTimeout)((()=>{window.requestAnimationFrame((()=>window.requestAnimationFrame(e)))}))})(r):(window.clearTimeout(i),i=void 0)},r=()=>{n&&!i&&o()},o=()=>{i=window.setTimeout((()=>{const i=t.didNetworkTimeOut();t.resetDidNetworkTimeOut(),e(i),l()}),a.CONFIG.idleTimeout)},l=t.subscribe(s);n&&s("IDLE")}const c=()=>{var e;return(null===(e=window.performance.getEntriesByType("navigation")[0])||void 0===e?void 0:e.type)||(()=>{const e=window.performance.navigation.type;return 2===e?"back_forward":1===e?"reload":"navigate"})()};class d{static isSupportedEnvironment(){var e;return void 0!==window&&"MutationObserver"in window&&"function"==typeof document.querySelectorAll&&(null===(e=window.performance)||void 0===e?void 0:e.timing)}constructor(e,t,i,a){if(this.mutationObserverConfig={attributeFilter:["hidden","style","src"],attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0},this.lastImageLoadTimestamp=-1,this.interactionCount=0,this.mutationCallback=e=>{e.forEach((e=>{var t,i,n;e.timestamp=performance.now(),(null!==(t=e.timestamp)&&void 0!==t?t:0)>=(null!==(n=null===(i=this.lastMutation)||void 0===i?void 0:i.timestamp)&&void 0!==n?n:0)&&(this.lastMutation=e)}))},this.handleLoadOrErrorEvent=e=>{e.target instanceof HTMLImageElement&&e.timeStamp>=this.lastImageLoadTimestamp&&(this.lastImageLoadTimestamp=e.timeStamp,this.lastImageLoadTarget=e.target)},this.cancel=()=>{this.activeMeasurementIndex=void 0},this.waitForIdle=e=>new Promise(((t,i)=>{if(new Promise(l).then(t,i),e&&this.measurementTimeout){const t=performance.now()-e,n=this.measurementTimeout-t;n<=0?i():setTimeout(i,n)}})),this.start=(e,t,i=0)=>n.__awaiter(this,void 0,void 0,(function*(){var n;if(!this.trackedComponent.current)return;const a=void 0!==t?t:performance.now(),r=this.interactionCount+=1;this.activeMeasurementIndex=r,this.trackedComponent.current.addEventListener("load",this.handleLoadOrErrorEvent,{capture:!0}),this.trackedComponent.current.addEventListener("error",this.handleLoadOrErrorEvent,{capture:!0}),this.mutationObserver.observe(this.trackedComponent.current,this.mutationObserverConfig);const o=()=>{this.activeMeasurementIndex===r&&this.cancel()},l=["click","keydown","pagehide","visibilitychange"];window.requestAnimationFrame((()=>{l.forEach((e=>{window.addEventListener(e,o)}))}));const c=null===(n=this.trackedComponent.current)||void 0===n?void 0:n.removeEventListener;try{const t=yield this.waitForIdle(a);this.reportMeasurement(a,r,t,e,i)}catch(e){s.reportStack(`Exceeded timeout of ${this.measurementTimeout} while waiting for CVC`,{severity:s.SEVERITY.NONCRITICAL,tags:["cvc"]})}l.forEach((e=>{c(e,o)})),r===this.interactionCount&&(c("load",this.handleLoadOrErrorEvent),c("error",this.handleLoadOrErrorEvent),this.mutationObserver.disconnect())})),this.reportMeasurement=(e,t,i,n,a)=>{var r,o,l,d;if(t!==this.activeMeasurementIndex)return;const m=Math.max(e,this.lastImageLoadTimestamp,null!==(o=null===(r=this.lastMutation)||void 0===r?void 0:r.timestamp)&&void 0!==o?o:0);if(m>Number.MAX_SAFE_INTEGER)return;if(e===m&&!this.reportOnNoChange)return;const u=m-e,h=31536e6;if(e>m||u>h||this.measurementTimeout&&u>this.measurementTimeout+10){const t=u>h?"Unreasonable duration in CVC measurement":"Unexpected duration in CVC measurement";s.reportStack(t,{severity:s.SEVERITY.NONCRITICAL,tags:["cvc"],exc_extra:{start:e,end:m,duration:u,timeout:this.measurementTimeout,componentKey:this.componentKey}})}else this.onCVC({start:e,end:m,duration:u,detail:{didNetworkTimeOut:i,lastVisibleChange:this.lastImageLoadTimestamp>(null!==(d=null===(l=this.lastMutation)||void 0===l?void 0:l.timestamp)&&void 0!==d?d:0)?this.lastImageLoadTarget:this.lastMutation,navigationType:n?"ajax":c(),pageRenderStart:a}})},!d.isSupportedEnvironment())throw new Error("VisuallyCompleteCalculator: This browser/runtime is not supported.");this.trackedComponent=e,this.onCVC=t,this.componentKey=i,a&&(this.reportOnNoChange=a.reportOnNoChange,this.measurementTimeout=a.measurementTimeout,this.mutationObserverCallback=a.mutationObserverCallback),this.mutationObserver=new MutationObserver(((e,t)=>{this.mutationCallback(e,t),this.mutationObserverCallback&&this.mutationObserverCallback(e)}))}}e.ComponentVisuallyCompleteCalculator=d,e.UEClient=o,e.getNavigationType=c}));
//# sourceMappingURL=c_user_centric_perf_metrics_component_visually_complete_component_visually_complete_calculator.js-vflNLxmvm.map
