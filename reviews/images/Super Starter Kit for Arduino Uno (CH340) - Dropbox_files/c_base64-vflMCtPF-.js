define(["exports","./c_init_data_runtime","./e_folder_viewer_src_main","./c_src_sink_index","./c_apex-metrics_src_types"],(function(e,t,r,n,i){"use strict";class a extends Error{}class o extends a{constructor(){super(...arguments),this.kind="AlgorithmNotFound"}}class c extends a{constructor(){super(...arguments),this.kind="EntropyLimitReached"}}class l extends a{constructor(e){super(e),this.kind="Unknown"}}class d extends a{constructor(e){super(e),this.kind="I2osp"}}class s extends a{constructor(){super(...arguments),this.kind="Decryption"}}class y extends a{constructor(){super(...arguments),this.kind="InvalidKey"}}class h extends a{constructor(){super(...arguments),this.kind="InvalidKeyFormat"}}class u extends a{constructor(){super(...arguments),this.kind="NoKeyFound"}}class _ extends a{constructor(){super(...arguments),this.kind="KeyMismatch"}}class p extends a{constructor(){super(...arguments),this.kind="ProhibitedUse"}}function g(e){switch(e[".tag"]){case"hpke_dhkem_p256_hkdf_sha256_hkdf_sha256_aes256_gcm":return"HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM";case"sender_auth_hpke_dhkem_p256_hkdf_sha256_hkdf_sha256_aes256_gcm":return"SENDER_AUTH_HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM";default:throw new o}}function f(e){if("aes256_gcm_extras"===e[".tag"])return"AES256_GCM_EXTRAS";throw new o}function m(e){const r=t.protoBase64.enc(e.encryptedKeyData);return{algorithm:(n=e.algorithm,"AES256_GCM_EXTRAS"===n?{".tag":"aes256_gcm_extras"}:{".tag":"unknown_symmetric_encryption_algorithm"}),encrypted_key_data:r,encrypting_key_id:e.encryptingKeyId};var n}function w(e){const r=t.protoBase64.dec(e.encrypted_private_key_data),n=t.protoBase64.dec(e.public_key_data);return{keyId:e.key_id,algorithm:g(e.algorithm),encryptedPrivateKeyData:r,publicKeyData:n,encryptingKeyId:e.encrypting_key_id}}function K(e){const r=t.protoBase64.dec(e.key_data);return{keyId:e.key_id,keyData:r,algorithm:g(e.algorithm)}}function v(e){return{fileKeys:e.file_keys.map((e=>function(e){const r=t.protoBase64.dec(e.encrypted_key_data);return{keyId:e.key_id,algorithm:f(e.algorithm),encryptedKeyData:r,encryptingKeyId:e.encrypting_key_id}}(e))),encryptingKeys:e.encrypting_keys.map((e=>w(e)))}}const k=e=>new r.DefaultUserApiV2Client(e).ns("ekms");function S(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=k(e);return(yield t.rpc("register_file_key_batch",{file_keys:r.map(m)},{})).file_keys.map((e=>e.key_id))}))}class E{generateKey(){var e;return t.__awaiter(this,void 0,void 0,(function*(){try{const e=yield crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt"]),t=yield crypto.subtle.exportKey("raw",e);return{algorithm:E.algorithm,keyData:new Uint8Array(t)}}catch(t){throw new l(null!==(e=t.message)&&void 0!==e?e:"WebCrypto key generation failed")}}))}encrypt(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(r.algorithm!==E.algorithm)throw new o;const t=yield crypto.subtle.importKey("raw",r.keyData,{name:"AES-GCM",length:256},!1,["encrypt"]).catch((()=>{throw new h}));n||(n=crypto.getRandomValues(new Uint8Array(12)));const i=yield crypto.subtle.encrypt({name:"AES-GCM",iv:n},t,e).catch((e=>{var t;throw new l(null!==(t=e.message)&&void 0!==t?t:"WebCrypto encryption failed")})),a=new Uint8Array(i.slice(-16));return{ciphertext:new Uint8Array(i.slice(0,-16)),extras:{nonce:n,authTag:a}}}))}decrypt(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(r.algorithm!==E.algorithm)throw new o;const t=yield crypto.subtle.importKey("raw",r.keyData,{name:"AES-GCM",length:256},!1,["decrypt"]).catch((()=>{throw new h})),i=new Uint8Array(e.length+n.authTag.length);i.set(e),i.set(n.authTag,e.length);const a=yield crypto.subtle.decrypt({name:"AES-GCM",iv:n.nonce},t,i).catch((()=>{throw new s}));return new Uint8Array(a)}))}serializeCryptoExtras(e){const t=new Uint8Array(e.authTag.length+e.nonce.length);return t.set(e.authTag),t.set(e.nonce,e.authTag.length),t}deserializeCryptoExtras(e){return{authTag:e.slice(0,16),nonce:e.slice(16)}}}E.algorithm="AES256_GCM_EXTRAS";const A={nSecret:32,nK:32,nN:12,nEnc:65,kdfId:1,kemId:16,aeadId:2},D={generateKeyPair(){return t.__awaiter(this,void 0,void 0,(function*(){const e=yield crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]).catch((e=>{throw new l(e.message)}));return{publicKey:e.publicKey,privateKey:e.privateKey}}))},sealWithKey(e){return t.__awaiter(this,void 0,void 0,(function*(){const{key:t,nonce:r,aad:n,pt:i}=e,a=yield crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!0,["encrypt","decrypt"]).catch((()=>{throw new h})),o=yield crypto.subtle.encrypt({name:"AES-GCM",iv:r,additionalData:n},a,i).catch((e=>{throw new l(e.message)}));return new Uint8Array(o)}))},openWithKey(e){return t.__awaiter(this,void 0,void 0,(function*(){const{key:t,nonce:r,aad:n,ct:i}=e,a=yield crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!0,["encrypt","decrypt"]).catch((()=>{throw new h})),o=yield crypto.subtle.decrypt({name:"AES-GCM",iv:r,additionalData:n},a,i).catch((()=>{throw new y}));return new Uint8Array(o)}))},serializePublicKey(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.exportKey("raw",e).catch((e=>{throw new l(e.message)}));return new Uint8Array(t)}))},deserializePublicKey(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]).catch((()=>{throw new h}))}))},extract(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=new Uint8Array(32).fill(0);let n;n=void 0===e||0===e.length?t:e;const i=8*n.length,a=yield crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256",length:i},!1,["sign"]).catch((()=>{throw new h}));return new Uint8Array(yield crypto.subtle.sign("HMAC",a,r).catch((e=>{throw new l(e.message)})))}))},expand(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256",length:256},!1,["sign"]).catch((()=>{throw new h})),i=new Uint8Array(new ArrayBuffer(n));let a=new Uint8Array(0);const o=null!=r?r:new Uint8Array(0);if(n>65280)throw new c;const d=256+o.length+1,s=new Uint8Array(d);for(let e=1,r=0;r<i.length;e++){s.set(a,0),s.set(o,a.length),s[a.length+o.length]=e;const n=a.length+o.length+1;a=new Uint8Array(yield crypto.subtle.sign("HMAC",t,s.slice(0,n)).catch((e=>{throw new l(e.message)}))),i.length-r>=a.length?(i.set(a,r),r+=a.length):(i.set(a.slice(0,i.length-r),r),r+=i.length-r)}return i}))},dh(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.deriveBits({name:"ECDH",public:r},e,256).catch((e=>{throw new l(e.message)}));return new Uint8Array(t)}))},pkFromSk(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.exportKey("jwk",e).catch((e=>{throw new l(e.message)}));return delete t.d,crypto.subtle.importKey("jwk",t,{name:"ECDH",namedCurve:"P-256"},!0,[]).catch((()=>{throw new h}))}))},info:()=>A,sha256(e){return t.__awaiter(this,void 0,void 0,(function*(){return new Uint8Array(yield crypto.subtle.digest("SHA-256",e))}))}};var b;function C(e,t){if(t<=0)throw new d("too small size");if(2!==t)throw new d("only allowed with w = 2");if(e>=256**t)throw new d("too large integer");return new Uint8Array([e>>8&255,255&e])}function H(e){const t=e.replace(/-/g,"+").replace(/_/g,"/"),r=4-t.length%4,n=4===r?t:t+"=".repeat(r),i=atob(n),a=new Uint8Array(i.length);for(let e=0;e<i.length;e++)a[e]=i.charCodeAt(e);return a}function P(e){const t=e.map((e=>e.byteLength)).reduce(((e,t)=>e+t),0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.byteLength;return r}function I(e,t){const r=Math.max(e.length,t.length),n=new Uint8Array(r),i=new Uint8Array(r);n.set(e,r-e.length),i.set(t,r-t.length);for(let e=0;e<r;e++){if(n[e]<i[e])return b.LeftSmallerThanRight;if(n[e]>i[e])return b.LeftBiggerThanRight}return b.Equal}!function(e){e[e.LeftSmallerThanRight=-1]="LeftSmallerThanRight",e[e.Equal=0]="Equal",e[e.LeftBiggerThanRight=1]="LeftBiggerThanRight"}(b||(b={}));const x={toPKCS8(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.exportKey("pkcs8",e).catch((e=>{throw new l(e.message)}));return new Uint8Array(t)}))},fromPKCS8(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield crypto.subtle.importKey("pkcs8",e,{name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]).catch((()=>{throw new h}))}))},toDer(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.exportKey("spki",e).catch((e=>{throw new l(e.message)}));return new Uint8Array(t)}))},fromDer(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield crypto.subtle.importKey("spki",e,{name:"ECDH",namedCurve:"P-256"},!0,[]).catch((()=>{throw new h}))}))},encode(e){return t.__awaiter(this,void 0,void 0,(function*(){return H((yield crypto.subtle.exportKey("jwk",e).catch((e=>{throw new l(e.message)}))).d)}))},toJWK(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.importKey("raw",e,{name:"ECDH",namedCurve:"P-256"},!0,[]);return yield crypto.subtle.exportKey("jwk",t)}))}};function T(e){const t=e.length/2,r=new Uint8Array(t);for(let n=0;n<t;n++){const t=parseInt(e.substr(2*n,2),16);r[n]=t}return r}function F(e){return e.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),"")}const M="ffffffff00000001000000000000000000000000ffffffffffffffffffffffff";function U(e){return t.__awaiter(this,void 0,void 0,(function*(){const r=yield crypto.subtle.exportKey("raw",e).catch((()=>{throw new y}));yield function(e){return t.__awaiter(this,void 0,void 0,(function*(){if("00"===F(e))throw new y}))}(new Uint8Array(r)),yield function(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=e.slice(1),r=t.slice(0,t.length/2),n=t.slice(t.length/2),i=T(M);if(I(r,T("00"))===b.LeftSmallerThanRight||I(r,i)===b.LeftBiggerThanRight||I(r,i)===b.Equal||I(n,T("00"))===b.LeftSmallerThanRight||I(n,i)===b.LeftBiggerThanRight||I(n,i)===b.Equal)throw new y}))}(new Uint8Array(r)),yield function(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield crypto.subtle.exportKey("spki",e).catch((()=>{throw new y}));yield crypto.subtle.importKey("spki",t,{name:"ECDH",namedCurve:"P-256"},!1,[]).catch((()=>{throw new y}))}))}(e)}))}const B=(new TextEncoder).encode("HPKE-v1"),R=new Uint8Array([0]),L=new Uint8Array([2]);function G(e,r,n,i){return t.__awaiter(this,void 0,void 0,(function*(){yield U(r);const{encappedKey:a,sharedSecret:o}=yield function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const{publicKey:t,privateKey:n}=yield e.generateKeyPair();yield U(t);const i=yield e.dh(n,r);if(i.every((e=>0===e)))throw new Error("DH result is the point at infinity");const a=yield e.serializePublicKey(t),o=P([a,yield e.serializePublicKey(r)]);return{encappedKey:a,sharedSecret:yield V(e,i,o)}}))}(e,r),{key:c,nonce:l}=yield O(e,R,o);return{encappedKey:a,cipherText:yield e.sealWithKey({key:c,nonce:l,aad:n,pt:i})}}))}function W(e,r,n,i,a){return t.__awaiter(this,void 0,void 0,(function*(){yield U(r);const{encappedKey:o,sharedSecret:c}=yield function(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield e.pkFromSk(n);yield U(t);const{publicKey:i,privateKey:a}=yield e.generateKeyPair();yield U(i);const o=P([yield e.dh(a,r),yield e.dh(n,r)]);if(o.every((e=>0===e)))throw new Error("DH result is the point at infinity");const c=yield e.serializePublicKey(i),l=P([c,yield e.serializePublicKey(r),yield e.serializePublicKey(t)]);return{encappedKey:c,sharedSecret:yield V(e,o,l)}}))}(e,r,n),{key:l,nonce:d}=yield O(e,L,c);return{encappedKey:o,cipherText:yield e.sealWithKey({key:l,nonce:d,aad:i,pt:a})}}))}function z(e,r,n,i,a){return t.__awaiter(this,void 0,void 0,(function*(){const o=yield function(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield e.pkFromSk(n);yield U(t);const i=yield e.deserializePublicKey(r);yield U(i);const a=yield e.dh(n,i);if(a.every((e=>0===e)))throw new Error("DH result is the point at infinity");const o=yield e.serializePublicKey(t),c=P([r,o]);return yield V(e,a,c)}))}(e,r,n),{key:c,nonce:l}=yield O(e,R,o);return yield e.openWithKey({key:c,nonce:l,aad:i,ct:a})}))}function j(e,r,n,i,a,o){return t.__awaiter(this,void 0,void 0,(function*(){const c=yield function(e,r,n,i){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield e.pkFromSk(n);yield U(t);const a=yield e.deserializePublicKey(r);yield U(a);const o=P([yield e.dh(n,a),yield e.dh(n,i)]);if(o.every((e=>0===e)))throw new Error("DH result is the point at infinity");const c=yield e.serializePublicKey(t),l=yield e.serializePublicKey(i),d=P([r,c,l]);return yield V(e,o,d)}))}(e,r,n,i),{key:l,nonce:d}=yield O(e,L,c);return yield e.openWithKey({key:l,nonce:d,aad:a,ct:o})}))}function O(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield q(e,N(e),new Uint8Array(0),(new TextEncoder).encode("info_hash"),new Uint8Array(0)),i=yield q(e,N(e),new Uint8Array(0),(new TextEncoder).encode("psk_id_hash"),new Uint8Array(0)),a=P([r,i,t]),o=yield q(e,N(e),n,(new TextEncoder).encode("secret"),new Uint8Array(0));return{key:yield X(e,N(e),o,(new TextEncoder).encode("key"),a,e.info().nK),nonce:yield X(e,N(e),o,(new TextEncoder).encode("base_nonce"),a,e.info().nN)}}))}function N(e){return P([(new TextEncoder).encode("HPKE"),C(e.info().kemId,2),C(e.info().kdfId,2),C(e.info().aeadId,2)])}function q(e,r,n,i,a){return t.__awaiter(this,void 0,void 0,(function*(){const t=P([B,r,i,a]);return yield e.extract(n,t)}))}function X(e,r,n,i,a,o){return t.__awaiter(this,void 0,void 0,(function*(){const t=P([C(o,2),B,r,i,a]);return e.expand(n,t,o)}))}function V(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield q(e,J(e),new Uint8Array(0),(new TextEncoder).encode("eae_prk"),r);return X(e,J(e),t,(new TextEncoder).encode("shared_secret"),n,e.info().nSecret)}))}function J(e){return P([(new TextEncoder).encode("KEM"),C(e.info().kemId,2)])}class Y{senderAuthenticated(){return!1}generateKeyPair(){return t.__awaiter(this,void 0,void 0,(function*(){const{publicKey:e,privateKey:t}=yield D.generateKeyPair(),r=yield x.toPKCS8(t),n=yield x.toDer(e);return{algorithm:Y.algorithm,privateKeyData:r,publicKey:{keyData:n,algorithm:Y.algorithm}}}))}encryptKeyPair(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(r.algorithm!==Y.algorithm)throw new o;const t=yield x.fromDer(r.keyData),{encappedKey:n,cipherText:i}=yield G(D,t,new Uint8Array(0),e.privateKeyData),a=P([n,i]);return{algorithm:e.algorithm,encryptedPrivateKeyData:a,publicKeyData:e.publicKey.keyData}}))}decryptKeyPair(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(r.publicKey.algorithm!==Y.algorithm)throw new o;const t=e.encryptedPrivateKeyData,n=t.slice(0,D.info().nEnc),i=t.slice(D.info().nEnc),a=yield x.fromPKCS8(r.privateKeyData),c=yield z(D,n,a,new Uint8Array(0),i);return{algorithm:e.algorithm,privateKeyData:c,publicKey:{keyData:e.publicKeyData,algorithm:e.algorithm}}}))}encryptKey(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(r.algorithm!==Y.algorithm)throw new o;const t=yield x.fromDer(r.keyData),{encappedKey:n,cipherText:i}=yield G(D,t,new Uint8Array(0),e.keyData),a=P([n,i]);return{algorithm:e.algorithm,encryptedKeyData:a,encryptingKeyId:r.keyId}}))}decryptKey(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(r.publicKey.algorithm!==Y.algorithm)throw new o;const t=e.encryptedKeyData,n=t.slice(0,D.info().nEnc),i=t.slice(D.info().nEnc),a=yield x.fromPKCS8(r.privateKeyData),c=yield z(D,n,a,new Uint8Array(0),i);return{algorithm:e.algorithm,keyData:c}}))}validateKeyPair(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield x.fromPKCS8(e.privateKeyData),r=yield D.pkFromSk(t),n=yield x.toDer(r),i=yield x.fromDer(e.publicKey.keyData),a=yield x.toDer(i);if(F(n)!==F(a)||e.algorithm!==Y.algorithm||e.publicKey.algorithm!==Y.algorithm)throw new _}))}}Y.algorithm="HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM";class Q{senderAuthenticated(){return!0}generateKeyPair(){return t.__awaiter(this,void 0,void 0,(function*(){const{publicKey:e,privateKey:t}=yield D.generateKeyPair(),r=yield x.toPKCS8(t),n=yield x.toDer(e);return{algorithm:Q.algorithm,privateKeyData:r,publicKey:{keyData:n,algorithm:Q.algorithm}}}))}encryptKeyPair(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(!n)throw new p;if(r.algorithm!==Q.algorithm||n.algorithm!==Q.algorithm)throw new o;const t=(new TextEncoder).encode(Q.algorithm.toLocaleLowerCase()),i=yield x.fromDer(r.keyData),a=yield x.fromPKCS8(n.privateKeyData),{encappedKey:c,cipherText:l}=yield W(D,i,a,t,e.privateKeyData),d=P([c,l]);return{algorithm:e.algorithm,encryptedPrivateKeyData:d,publicKeyData:e.publicKey.keyData}}))}decryptKeyPair(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(!n)throw new p;if(r.publicKey.algorithm!==Q.algorithm||n.algorithm!==Q.algorithm)throw new o;const t=(new TextEncoder).encode(Q.algorithm.toLocaleLowerCase()),i=e.encryptedPrivateKeyData,a=i.slice(0,D.info().nEnc),c=i.slice(D.info().nEnc),l=yield x.fromPKCS8(r.privateKeyData),d=yield x.fromDer(n.keyData),s=yield j(D,a,l,d,t,c);return{algorithm:e.algorithm,privateKeyData:s,publicKey:{keyData:e.publicKeyData,algorithm:e.algorithm}}}))}encryptKey(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(!n)throw new p;if(r.algorithm!==Q.algorithm||n.algorithm!==Q.algorithm)throw new o;const t=(new TextEncoder).encode(Q.algorithm.toLocaleLowerCase()),i=yield x.fromDer(r.keyData),a=yield x.fromPKCS8(n.privateKeyData),{encappedKey:c,cipherText:l}=yield W(D,i,a,t,e.keyData),d=P([c,l]);return{algorithm:e.algorithm,encryptedKeyData:d,encryptingKeyId:r.keyId}}))}decryptKey(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){if(!n)throw new p;if(r.publicKey.algorithm!==Q.algorithm||n.algorithm!==Q.algorithm)throw new o;const t=(new TextEncoder).encode(Q.algorithm.toLocaleLowerCase()),i=e.encryptedKeyData,a=i.slice(0,D.info().nEnc),c=i.slice(D.info().nEnc),l=yield x.fromPKCS8(r.privateKeyData),d=yield x.fromDer(n.keyData),s=yield j(D,a,l,d,t,c);return{algorithm:e.algorithm,keyData:s}}))}validateKeyPair(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=yield x.fromPKCS8(e.privateKeyData),r=yield D.pkFromSk(t),n=yield x.toDer(r),i=yield x.fromDer(e.publicKey.keyData),a=yield x.toDer(i);if(F(n)!==F(a)||e.algorithm!==Q.algorithm||e.publicKey.algorithm!==Q.algorithm)throw new _}))}}Q.algorithm="SENDER_AUTH_HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM";function Z(e){switch(e){case"HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM":return new Y;case"SENDER_AUTH_HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM":return new Q;default:throw new o}}function $(e){if("AES256_GCM_EXTRAS"===e)return new E;throw new o}const ee="encrypted_folder_web";class te{constructor(e,t,r){this.metric=t.createStats(e,r),this.clock=new n.BrowserPerformanceClock,this.startTimer()}record(e){const t=e/(1e3*(n.Instant.toMilliseconds(this.clock.now())-this.value));this.metric.record(t),this.startTimer()}startTimer(){this.value=n.Instant.toMilliseconds(this.clock.now())}}class re{constructor(){const e=n.getMetricsReporter();this.createStats=(t,r)=>e.createStats({ns:ee,name:t},r);const t=(t,r)=>e.createCounter({ns:ee,name:t},r);this.createBandwidth=(t,r)=>new te({ns:ee,name:t},e,r),this.downloadHandleSingleFile=t("download/handle_single_file"),this.serviceWorkerMetadataPosted=t("service_worker/metadata_posted"),this.teamEnrollmentBoltStarted=t("team_enrollment/bolt_started"),this.teamEnrollmentBoltEnrolled=t("team_enrollment/bolt_enrolled"),this.teamEnrollmentFail=t("team_enrollment/enroll_fail"),this.clientKeyBoltStarted=t("client_key/bolt_started"),this.clientKeyBoltEnrolled=t("client_key/bolt_enrolled"),this.clientKeyRegistrationFail=t("client_key/registration_fail")}static getInstance(){return re.instance||(re.instance=new re),re.instance}}const ne={downloadHandleSingleFile:()=>{re.getInstance().downloadHandleSingleFile.increment(),re.getInstance().downloadHandleSingleFile.record()},ekmsLoadClientKeyFail:()=>{re.getInstance().createStats("ekms/load_client_key_fail").record(1)},ekmsLoadFileKeysFail:(e,t)=>{const r=e instanceof a?e.kind:"Other";re.getInstance().createStats("ekms/load_file_keys_fail",{error:r,context:t}).record(1)},serviceWorkerMetadataPosted:()=>{re.getInstance().serviceWorkerMetadataPosted.increment(),re.getInstance().serviceWorkerMetadataPosted.record()},serviceWorkerState:e=>{re.getInstance().createStats("service_worker/state",{state:e}).record(1)},teamEnrollmentCheck:e=>{re.getInstance().createStats("team_enrollment/status",{status:e}).record(1)},teamEnrollmentBoltStarted:()=>{re.getInstance().teamEnrollmentBoltStarted.increment(),re.getInstance().teamEnrollmentBoltStarted.record()},teamEnrollmentBoltEnrolled:()=>{re.getInstance().teamEnrollmentBoltEnrolled.increment(),re.getInstance().teamEnrollmentBoltEnrolled.record()},teamEnrollmentFail:()=>{re.getInstance().teamEnrollmentFail.increment(),re.getInstance().teamEnrollmentFail.record()},clientKeyHandleRegistration:e=>{re.getInstance().createStats("client_key/handle_registration",{attempt:String(e)}).record(1)},clientKeyBoltStarted:()=>{re.getInstance().clientKeyBoltStarted.increment(),re.getInstance().clientKeyBoltStarted.record()},clientKeyBoltEnrolled:()=>{re.getInstance().clientKeyBoltEnrolled.increment(),re.getInstance().clientKeyBoltEnrolled.record()},clientKeyHandleExisting:e=>{re.getInstance().createStats("client_key/handle_existing",{enrolled:String(e)}).record(1)},clientKeyHandleStore:(e,t)=>{re.getInstance().createStats("client_key/handle_store",{existing:String(e),enrolled:String(t)}).record(1)},clientKeyRegistrationFail:()=>{re.getInstance().clientKeyRegistrationFail.increment(),re.getInstance().clientKeyRegistrationFail.record()},uploadEncryptFail:e=>{const t=e instanceof a?e.kind:"Other";re.getInstance().createStats("upload/encrypt_fail",{error:t}).record(1)},uploadComputeFileEncryptionInfoFail:e=>{const t=e instanceof a?e.kind:"Other";re.getInstance().createStats("upload/encrypt_fail",{error:t}).record(1)},uploadEncryptBandwidth:()=>re.getInstance().createBandwidth("upload/encrypt/throughput_per_sec"),uploadFileKeyHandlingRequired:e=>{re.getInstance().createStats("upload/file_key_handling_required",{overwrite:String(e.overwrite),expired_key:String(e.expiredKey)}).record(1)},uploadCommitFail:(e,t)=>{re.getInstance().createStats("upload/commit_fail",{overwrite:String(e),reason:t}).record(1)}};var ie;e.ServiceWorkerState=void 0,(ie=e.ServiceWorkerState||(e.ServiceWorkerState={})).active="active",ie.activated="activated",ie.hanging="hanging";const ae=null;function oe(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const i=function(e){const t=new Map;for(const r of e){const e=r.encryptingKeyId;t.has(e)?t.get(e).push(r):t.set(e,[r])}return t}(e),a=yield ce(i,n),o=r.map((e=>t.__awaiter(this,void 0,void 0,(function*(){return yield function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=e.find((e=>e.keyId===r.encryptingKeyId));if(t){const e=Z(t.algorithm),n=yield e.decryptKey(r,t,ae);return Object.assign({keyId:r.keyId},n)}throw new u}))}(a,e)}))));return Promise.all(o).catch((e=>(ne.ekmsLoadFileKeysFail(e,"Decrypt"),Promise.reject(e))))}))}function ce(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const n=e.get(r.keyId);if(!n)return[];const i=yield function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){return Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){const t=Z(r.algorithm),n=yield t.decryptKeyPair(e,r,ae);return Z(n.algorithm).validateKeyPair(n),Object.assign({keyId:e.keyId},n)})))))}))}(n,r),a=yield Promise.all(i.map((r=>t.__awaiter(this,void 0,void 0,(function*(){return ce(e,r)})))));return i.push(...[].concat(...a)),i}))}function le(e){const t=[];let r=0,n=0,i=0,a=0,o=0;for(e+="";r<e.length;)i=e.charCodeAt(r),i<128?(t[n++]=String.fromCharCode(i),r++):i>191&&i<224?(a=e.charCodeAt(r+1),t[n++]=String.fromCharCode((31&i)<<6|63&a),r+=2):(a=e.charCodeAt(r+1),o=e.charCodeAt(r+2),t[n++]=String.fromCharCode((15&i)<<12|(63&a)<<6|63&o),r+=3);return t.join("")}e.CURRENT_SYM_ALGORITHM_CONTENT="AES256_GCM_EXTRAS",e.IncorrectKeyInputError=class extends a{constructor(){super(...arguments),this.kind="IncorrectKeyInput"}},e.InvalidKeyLengthError=class extends a{constructor(){super(...arguments),this.kind="InvalidKeyLength"}},e.KeyEncoding=x,e.WebcryptoHPKESuite=D,e.algorithmToAsymmetricEncryptionAlgorithmProto=function(e){switch(e){case"HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM":return{".tag":"hpke_dhkem_p256_hkdf_sha256_hkdf_sha256_aes256_gcm"};case"SENDER_AUTH_HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM":return{".tag":"sender_auth_hpke_dhkem_p256_hkdf_sha256_hkdf_sha256_aes256_gcm"};default:return{".tag":"unknown_asymmetric_encryption_algorithm"}}},e.areUint8ArraysEqual=function(e,t){return e.length===t.length&&e.every(((e,r)=>e===t[r]))},e.base64UrlDecode=H,e.base64UrlEncode=function(e){return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_")},e.bytesToHexString=F,e.calculateHmacSha256=(e,r)=>t.__awaiter(void 0,void 0,void 0,(function*(){var t;try{const t=yield crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),n=yield crypto.subtle.sign("HMAC",t,r);return new Uint8Array(n)}catch(e){throw new l(null!==(t=e.message)&&void 0!==t?t:"WebCrypto hmac generation failed")}})),e.createAsymmetricCoreCrypto=Z,e.createFileKeyDrafts=function(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const i=$("AES256_GCM_EXTRAS"),a=yield function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=k(e);return K((yield t.rpc("get_namespace_public_key",{ns_id:r},{})).namespace_key)}))}(e,r),o=Z(a.algorithm),c=yield Promise.all(new Array(n).fill(0).map((()=>i.generateKey())));return Promise.all(c.map((e=>t.__awaiter(this,void 0,void 0,(function*(){return{draft:yield o.encryptKey(e,a,ae),key:e}})))))}))},e.createSymmetricCoreCrypto=$,e.decode=function(e,t){const r=t?e=>e:le;if("function"==typeof window.atob)return r(window.atob(e));const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let i=0,a=0;const o=[];if(!e)return e;for(e+="";;){const t=n.indexOf(e.charAt(i++)),r=n.indexOf(e.charAt(i++)),c=n.indexOf(e.charAt(i++)),l=n.indexOf(e.charAt(i++)),d=t<<18|r<<12|c<<6|l,s=d>>16&255,y=d>>8&255,h=255&d;if(o[a++]=64===c?String.fromCharCode(s):64===l?String.fromCharCode(s,y):String.fromCharCode(s,y,h),!(i<e.length))break}let c=o.join("");return c=r(c),c},e.encode=function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let r,n,i,a,o,c,l,d,s=0,y=0,h="";const u=[];if(!e)return e;for(;r=e.charCodeAt(s++),n=e.charCodeAt(s++),i=e.charCodeAt(s++),d=r<<16|n<<8|i,a=d>>18&63,o=d>>12&63,c=d>>6&63,l=63&d,u[y++]=t.charAt(a)+t.charAt(o)+t.charAt(c)+t.charAt(l),s<e.length;);h=u.join("");const _=e.length%3;return(_?h.slice(0,_-3):h)+"===".slice(_||3)},e.encryptedFolderMetrics=ne,e.getAlgorithmFromVersion=function(e){if("D1"===e)return"HPKE_DHKEM_P256_HKDF_SHA256_HKDF_SHA256_AES256_GCM";throw new o},e.getTeamKeyListFromBackupKey=function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const n=yield function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){const t=k(e);return(yield t.rpc("get_encrypted_team_key_list_with_backup_key",{backup_key_id:r},{})).encrypted_team_keys.map((e=>w(e)))}))}(e,r.keyId),i=Z(r.algorithm),a={algorithm:r.algorithm,privateKeyData:r.privateKeyData,publicKey:r.publicKey},o=yield Promise.all(n.map((e=>i.decryptKeyPair(e,a,ae))));return o.forEach((e=>{Z(e.algorithm).validateKeyPair(e)})),o.map(((e,t)=>Object.assign({keyId:n[t].keyId},e)))}))},e.getTeamPublicKey=function(e){return t.__awaiter(this,void 0,void 0,(function*(){return yield function(e){return t.__awaiter(this,void 0,void 0,(function*(){const t=k(e);return K((yield t.rpc("get_team_public_key",void 0,{})).team_key)}))}(e)}))},e.hexStringToBytes=T,e.loadFileKeys=function(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const i=yield function(e,r,n){return t.__awaiter(this,void 0,void 0,(function*(){const t=k(e);return v(yield t.rpc("get_file_keys",{root_key_id:r,file_key_ids:n},{}))}))}(e,n.keyId,r).catch((e=>(ne.ekmsLoadFileKeysFail(e,"RPC"),Promise.reject(e))));return oe(i.encryptingKeys,i.fileKeys,n)}))},e.registerFileKeysBatched=function(e,r){return t.__awaiter(this,void 0,void 0,(function*(){let t=[];const n=r.length;for(let i=0;i<n;i+=120){const a=Math.min(120,n-i),o=r.slice(i,i+a).map((e=>e.draft));t=t.concat(yield S(e,o))}return new Map(t.map(((e,t)=>[r[t].uploadId,Object.assign({keyId:e},r[t].key)])))}))}}));
//# sourceMappingURL=c_base64.js-vflYEX0wR.map
