define(["exports","./c_init_data_runtime","./e_folder_viewer_src_main","./c_growth_ui_api","./c_files_view_data_store","./c_browse_data_selectors","./c_flows_utils_browse_logger","./c_react_query_helpers_helpers","react","./c_core_i18n","./c_core_uri","./c_flows_redux_store","./c_flows_redux_reducer","./c_flows_utils_async_modal_launchers","./c_flows_redux_actions","./c_workflow_builder_workflow_actions_action_ui_config","./c_flows_redux_selectors","./c_ui-icon_sync_issue","./c_file_viewer_collection_viewer","./e_core_exception","./c_browse_tts","./c_flows_logging_flows_loggers","react-dom","./c_ui-icon_line_zip"],(function(e,t,o,n,i,a,s,r,l,c,u,d,_,f,g,p,m,v,b,h,A,w,k,y){"use strict";function E(e){return e&&e.__esModule?e:{default:e}}function S(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(o){if("default"!==o){var n=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,n.get?n:{enumerable:!0,get:function(){return e[o]}})}})),t.default=e,Object.freeze(t)}var M=E(l),O=S(k);function C(e,t,o,i){const a={update_adoption_status_arg:{".tag":"update_automated_adoption_status_arg",conversion_type:e,folder_rule_action:t,do_not_show:i}};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("update_adoption_status",a,{subjectUserId:o})}const T={icon:v.AutomationLine,name:"automate_current_folder",text:c.intl.formatMessage({id:"/Z33r/",defaultMessage:"Yes, automate folder"}),onClick:R((function e(t){P();const{filePath:n,conversionArg:i,userId:a,ns_id:r}=t;if(!i)return;const{conversionType:l,folderRuleAction:c}=i;C(l,c,a,!1);const u=o.parent_dir(n),f=o.parentDirName(n);s.showPendingSnackbar({folderName:f,type:"add"});const p=d.getStoreForAutomations(),m=N(i);if(!m)return void s.showErrorSnackbar({folderName:f,onRetry:()=>{e(t)},type:"generic-add"});_.updateFolderRule({fqPath:u,actions:[{actionType:c,data:m}],enabled:!0,applyToExistingFiles:!1,trigger:_.DEFAULT_CLIENT_FOLDER_TRIGGER}).then((()=>{s.logAutoFolderEvent(o.WebUserActionLogEvent.CONFIRM_ADD_FOLDER_RULES,{user_id:a,file_nsid:r,extra:{rule_type:c,entry_point:"adoption_snackbar"}}),p.dispatch(g.addUserAutomation({actions:[{actionType:c,data:m}],inheritable:!1,fqPath:u,isEnabled:!0,nsId:r,trigger:_.DEFAULT_CLIENT_FOLDER_TRIGGER})),s.showSuccessSnackbar({folderName:f,shouldShowDashboardCta:!0,type:"add"})}),(n=>{var i;s.logAutoFolderEvent(o.WebUserActionLogEvent.CONFIRM_ADD_FOLDER_RULES,{user_id:a,file_nsid:r,extra:{rule_type:c,error:null===(i=n.error)||void 0===i?void 0:i[".tag"],entry_point:"adoption_snackbar"}}),s.showErrorSnackbar({folderName:f,onRetry:()=>{e(t)},type:"generic-add"})}))}),"automate_folder")},F={name:"show_me_how_to_automate",text:c.intl.formatMessage({id:"Y2ppp4",defaultMessage:"Show me"}),onClick:R(U,"show_me")},x={name:"do_not_show_me_this_again",text:c.intl.formatMessage({id:"g74H0b",defaultMessage:"Skip"}),onClick:R(j,"dont_show_again")};function I(e){const{user:t,conversionType:n,folderRuleAction:s,resultPath:r,source:l,nsId:u}=e;if(!function(e){const t=!!a.isInsideFlowsEligibleFolder(i.getStoreForBrowse().getState()),n=null!=m.getUserAutomation(o.parent_dir(e))(d.getStoreForAutomations().getState());return t&&!n}(r))return;const _={user:t,conversionType:n,folderRuleAction:s,fileType:"unzip"===s?void 0:e.fileType,source:l},f={userId:t.id,filePath:r||"",ns_id:u,conversionArg:_},g="unzip"===s?c.intl.formatMessage({id:"+Ath7j",defaultMessage:"Want to automatically unzip files by setting up an automated folder?"}):c.intl.formatMessage({id:"+9Utp7",defaultMessage:"Want to automatically save {fileType} copies by setting up an automated folder?"},{fileType:e.fileType.toUpperCase()});return{actions:[T,F,x],helperText:g,clickHandlerArgs:f}}function R(e,t){return n=>{const{userId:a,conversionArg:s,ns_id:r}=n;if(!s)return;const{folderRuleAction:l,source:c}=s;i.logAutoFolderAdoptionSnackbar({user_id:a,action_source:"adoption",event_name:o.WebUserActionLogEvent.AUTOMATED_FOLDER_ADOPTION_SNACKBAR_CLICK,file_nsid:r,trigger_rule:l,snackbar_click_option:t,source:c}),e(n)}}function U({userId:e,filePath:t,ns_id:n,conversionArg:i}){if(!i)return;const{conversionType:a,folderRuleAction:s}=i,r=o.parent_dir(t),l=N(i);C(a,s,e,!1),f.asyncLaunchWorkflowBuilder({operation:"add",folderFqPath:r,surface:"browse",entryPoint:"adoption_snackbar",actionElement:"adoption_snackbar",initialActionType:s,initialActionData:l,initialScreen:"settings",initialTriggerType:"file_add"}),P()}function j({userId:e,conversionArg:t}){if(!t)return;const{conversionType:o,folderRuleAction:n}=t;C(o,n,e,!0),P()}function P(){o.Snackbar$1.close("flows-conversion-snackbar")}function N(e){const{folderRuleAction:t,fileType:o}=e,n=p.loadWorkflowActionUi(t),i=null==n?void 0:n.defaultAction.data;if(i)switch(t){case"image_conversion":case"video_conversion":i.format=o}return i}o.injectInternalStyle("/static/metaserver/static/js/flows/conversions/adoption.module.out-vflavgTy9.css",(e=>"._adoptionTooltipContainer_kztpv_1{background-color:var(--color__core__primary);bottom:0;height:210px;margin-bottom:150px;margin-right:50px;padding:15px 15px 10px;position:fixed;right:0;width:220px;z-index:1000}._additionalButton_kztpv_14{margin-left:var(--spacing__unit--2)}._tooltipCloseButton_kztpv_18{margin-right:var(--spacing__unit--1);margin-top:var(--spacing__unit--1);position:absolute;right:0;top:0}@media only screen and (max-width:640px){._adoptionTooltipContainer_kztpv_1{display:none}}"));const L="_adoptionTooltipContainer_kztpv_1",z="flows_adoption_tooltip";function D(){const e=document.getElementById(z);e&&e.remove()}const B=({outputExt:e,folderRuleAction:t,clickHandlerArgs:n})=>{const i="unzip"===t?c.intl.formatMessage({id:"7bOS9k",defaultMessage:"Automatically unzip compressed files"}):c.intl.formatMessage({id:"W0dLEK",defaultMessage:"Automatically convert files to {outputExt}s"},{outputExt:null==e?void 0:e.toUpperCase()}),a="unzip"===t?c.intl.formatMessage({id:"kLjQYK",defaultMessage:"Set up this folder to automatically unzip compressed files as they are added."}):c.intl.formatMessage({id:"r7sQQK",defaultMessage:"Set up this folder to automatically convert files to {outputExt}s as they are added."},{outputExt:null==e?void 0:e.toUpperCase()});return M.default.createElement(M.default.Fragment,null,M.default.createElement(o.Title,{size:"standard",inverse:!0},i),M.default.createElement(o.IconButton,{variant:"borderless",className:"_tooltipCloseButton_kztpv_18",inverse:!0,onClick:D},M.default.createElement(o.UIIcon,{src:o.CloseLine})),M.default.createElement(o.Text,{inverse:!0,size:"small",tagName:"p"},a),M.default.createElement(o.Button,{onClick:()=>{U(n),D()},variant:"outline",inverse:!0},c.intl.formatMessage({id:"vvt1hU",defaultMessage:"Yes, show me"})),M.default.createElement(o.Button,{className:"_additionalButton_kztpv_14",onClick:()=>{j(n),D()},variant:"transparent",inverse:!0},c.intl.formatMessage({id:"tEEvw9",defaultMessage:"Skip"})))};B.displayName="AdoptionTooltip";const W="flows-conversion-snackbar",G=268435456;function V(e){var a;return t.__awaiter(this,void 0,void 0,(function*(){const{file:t,user:l,shareToken:c,conversionFn:u,loggingFunctions:_,conversionType:f,folderRuleAction:g,getAdoptionSnackbarProps:p,source:v,template:h,outputExt:w,asyncThresholdBytes:k}=e;A.logBrowseTTS("workflows_save_as"),_.logConvert(v);const y=k||G;if(t.bytes>y&&h)return s.updateSnackbar({variant:"sync",title:"Loading"}),void(yield Q(t,h,v,c));q(Object.assign(Object.assign({},e),{state:"saving"}));try{const s=yield u(t,l,c);if(s){const c=p?p(s):void 0;let u=!1;if(c&&g){const e=yield function(e,t,o){const i={check_adoption_status_arg:{".tag":"check_automation_adoption_status_arg",conversion_type:e,folder_rule_action:t}};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("check_adoption_status",i,{subjectUserId:o})}(f,g,l.id);u="show_automation_adoption_tooltips"===(null===(a=e.check_automation_adoption_status_result)||void 0===a?void 0:a[".tag"])&&e.check_automation_adoption_status_result.show_automation_adoption_tooltips.valueOf()}if(u&&"video-home"!==v){(function(){const e=d.getStoreForAutomations().getState(),t=m.getUserExperiments(e).find((e=>e.feature===n.UI_EXPERIMENTS.ADOPTION_UI_VARIANT));return"V3_TOOLTIP"===(null==t?void 0:t.variant)})()?(q(Object.assign(Object.assign({},e),{state:"success",resultPath:s})),function(e,t,o){if(!e&&"unzip"!==t||!t||!o)return;let n=document.getElementById(z);n&&n.remove(),n=document.createElement("div"),n.className=L,n.id=z,document.body.insertBefore(n,document.body.firstChild);const i=M.default.createElement(B,{outputExt:e,folderRuleAction:t,clickHandlerArgs:o});O.render(i,n)}(w,g,null==c?void 0:c.clickHandlerArgs)):(i.logAutoFolderAdoptionSnackbar({user_id:l.id,action_source:"adoption",event_name:o.WebUserActionLogEvent.AUTOMATED_FOLDER_ADOPTION_SNACKBAR_SHOW,file_nsid:t.ns_id,source:v,trigger_rule:g}),q(Object.assign(Object.assign({},e),{state:"successAutomatedAdoption",resultPath:s,adoptionSnackbarProps:c})))}else q(Object.assign(Object.assign({},e),{state:"success",resultPath:s}))}else q(Object.assign(Object.assign({},e),{state:"failGeneric"}));return s}catch(t){const o=b.getConversionStateFromException(t);return void q(Object.assign(Object.assign({},e),{state:o}))}}))}function q(e){const{user:t,getStrings:n,state:i,resultPath:a,loggingFunctions:s,adoptionSnackbarProps:r,source:l}=e,u=Object.assign(Object.assign({},n(a||"",{clickableFileName:!!r,loggingFunctions:s,source:l})),{open:c.intl.formatMessage({id:"+JIEsO",defaultMessage:"Open"}),close:c.intl.formatMessage({id:"In8b64",defaultMessage:"Close"}),retry:c.intl.formatMessage({id:"Y/tkCj",defaultMessage:"Try again"})}),d={closeButtonText:u.close,onCloseClick:()=>s.logConvertClose(l)},_={saving:{variant:"sync",syncProgressLoop:!0},failGeneric:Object.assign({variant:"fail"},d),failOverQuota:Object.assign({variant:"fail"},d),failTooLarge:Object.assign({variant:"fail"},d),failCorrupt:Object.assign({variant:"fail"},d),failPassword:Object.assign({variant:"fail"},d),failPasswordLink:Object.assign({variant:"fail"},d),failRetryable:Object.assign({variant:"fail",onActionClick:()=>{s.logConvertRetry(l),V(e)}},d),successAutomatedAdoption:Object.assign({variant:"complete",onActionClick:()=>H(t,a,s,l),richSnackbarProps:r},d),success:Object.assign({variant:"complete",actionButtonText:u.open,onActionClick:()=>H(t,a,s,l)},d)};o.Snackbar$1.update(M.default.createElement(o.Snackbar$1,Object.assign({id:W,title:u[i]},_[i])))}function H(e,t,n,i){n.logConvertOpen(i),o.replace_location(o.preview_uri_for_fq_path(e,t))}function Q(e,n,i,a){return t.__awaiter(this,void 0,void 0,(function*(){const t=d.getStoreForAutomations();t.dispatch(g.setShouldSubscribeToBolt(!0));const s=p.mapConversionSourceToWorkflowEntrypoint(i),l=b.getFileIdentifier(e,a);let c;if(l&&l.identifier&&(c="shared_link_url"===l.identifier[".tag"]&&""!==l.identifier.shared_link_url?l.identifier.shared_link_url:void 0),o.isSharedFile(e)){t.dispatch(g.getWorkflowStepsConfig());const i=r.getActiveUser(),{submitFileWorkflow:a}=b.makeMetaserverFlowsClient(new o.DefaultUserApiV2Client(i));a({template:n,file_ids:[e.file_id],shared_link_url:c},60)}else try{yield _.submitFileWorkflow(n,[e.file_id],c),w.PapLogger.logSucceedSubmitManualWorkflow(s,n,1)}catch(e){w.PapLogger.logFailSubmitManualWorkflow(s,n,1,e)}}))}const Z=o.defineMessage({id:"u1R/iY",defaultMessage:"Extract all"}),K="unzip",Y={actionText:c.intl.formatMessage(Z),actionIcon:y.ZipLine,selector:b.singleFileWithExtensionSelector(n.SUPPORTED_UNZIP_EXTENSIONS),convert:(e,o,i)=>{const{source:a}=i;return V(Object.assign(Object.assign({},i),{file:e[0],user:o,loggingFunctions:b.getConversionLoggingFunctions(K),conversionType:K,folderRuleAction:"unzip",getStrings:(e,t)=>J(e,o,t),conversionFn:(e,o,i)=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=yield function(e,t,o){const i={file:t,dest_path:o};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("unzip",i,{subjectUserId:e})}(o.id,b.getFileIdentifier(e,i));return t.path})),getAdoptionSnackbarProps:t=>I({user:o,conversionType:K,folderRuleAction:"unzip",resultPath:t,source:a,nsId:e[0].ns_id}),template:{sequence:[{workflow_action:{".tag":"unzip"}}]},outputExt:""}))}},J=(e,t,n)=>{const a=c.intl.formatMessage({id:"gJnC96",defaultMessage:"Couldn't extract files"}),s=b.getSuccessString(e,((i,a)=>c.intl.formatMessage({id:"oxpxVW",defaultMessage:"Files extracted to <a>{folderName}</a> in {parentFolderName} folder"},{folderName:i,parentFolderName:a,a:i=>(null==n?void 0:n.clickableFileName)?M.default.createElement(o.Link,{inverse:!0,href:o.get_browse_root(t)+u.URI.encode_parts(e),onClick:()=>{var e;null===(e=null==n?void 0:n.loggingFunctions)||void 0===e||e.logConvertOpen(null==n?void 0:n.source)}},i):i})),(e=>c.intl.formatMessage({id:"TRohxO",defaultMessage:"Files extracted to {folderName} in your main Dropbox folder"},{folderName:e})));return{saving:c.intl.formatMessage({id:"Jk+n/I",defaultMessage:"Extracting files..."}),success:s,successAutomatedAdoption:s,failGeneric:a,failRetryable:a,failOverQuota:c.intl.formatMessage({id:"atcchQ",defaultMessage:"Couldn't extract because your Dropbox account is out of space"}),failTooLarge:c.intl.formatMessage({id:"Hgd1fQ",defaultMessage:"Couldn't extract files. Can only handle files up to {fileSize} MB"},{fileSize:i.UNZIP_MAX_FILESIZE_MB}),failCorrupt:c.intl.formatMessage({id:"00qMd1",defaultMessage:"Couldn't extract because the file is damaged"}),failPassword:c.intl.formatMessage({id:"xbgxEF",defaultMessage:"Couldn't extract because the file is password protected"}),failPasswordLink:c.intl.formatMessage({id:"UvS9P9",defaultMessage:"Couldn't extract because the file was shared using a password-protected link"})}};var X=Object.freeze({__proto__:null,UNZIP_ACTION_MESSAGE:Z,UnzipAction:Y});e.UNZIP_ACTION_MESSAGE=Z,e.UnzipAction=Y,e.convertDocToImage=function(e,t,o,i){const a={file:t,format:o,dest_path:i};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("convert_doc_to_image",a,{subjectUserId:e})},e.convertFileAndShowSnackbar=V,e.convertImageFormat=function(e,t,o,i){const a={file:t,format:o,dest_path:i};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("convert_image_format",a,{subjectUserId:e})},e.convertSingleFileAsynchronously=Q,e.convertToPdf=function(e,t,o){const i={file:t,dest_path:o};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("convert_to_pdf",i,{subjectUserId:e})},e.getAdoptionSnackbarProps=I,e.mediaRemux=function(e,t,o,i){const a={file:t,dest_path:i,container:o};return n.GetFlowsRoutes(new r.UserApiV2Client).rpc("media_remux",a,{subjectUserId:e})},e.unzip_esnext=X}));
//# sourceMappingURL=c_conversions_actions_unzip.js-vflisU92r.map
