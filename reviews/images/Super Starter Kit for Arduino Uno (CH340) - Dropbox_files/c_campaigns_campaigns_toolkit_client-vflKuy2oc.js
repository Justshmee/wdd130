define(["exports","./c_init_data_runtime","react","./e_folder_viewer_src_main","./c_react_query_helpers_helpers","./c_api_v2_noauth_client","./e_core_exception","./c_campaigns_campaign_enums","./c_lodash-es_lodash","./e_edison","./c_core_uri","./c_apex-metrics_src_types","./c_init_data_edison","./c_src_sink_index","./c_core_xhr","./c_csrf","./c_core_attribution_header","./c_core_i18n","metaserver/static/js/langpack","./c_api_v2_client_base","./c_core_notify","react-dom","metaserver/static/js/modules/constants/web_experience_constants","metaserver/static/js/modules/constants/sharing","metaserver/static/js/modules/constants/locales","metaserver/static/js/modules/constants/file_viewer_configuration","metaserver/static/js/modules/constants/file_viewer_feature_experiments","metaserver/static/js/modules/constants/time","metaserver/static/js/modules/constants/login_and_register","metaserver/static/js/modules/constants/fingerprintjs_constants","./c_security_crypto","metaserver/static/js/modules/constants/viewer"],(function(e,a,t,n,i,s,o,c,r,p,l,_,g,m,u,d,v,E,f,C,S,h,O,I,b,A,T,D,y,P,j,w){"use strict";function x(e){return e&&e.__esModule?e:{default:e}}var N=x(t);const q=()=>N.default.createElement(n.CampaignSlot,{slotId:"fullscreen_overlay"}),L=e=>{for(const a of e)window.clearTimeout(a)},M=(e,a)=>{const t=[];return e.forEach((e=>{var i,s,o;if(null===(i=null==e?void 0:e.campaign)||void 0===i?void 0:i.delay_in_seconds){n.logDelaySchedulingEvent(e,e.campaign.delay_in_seconds);const i=(s=()=>{n.emitCampaignToSlot(e,a)},o=1e3*e.campaign.delay_in_seconds,window.setTimeout(s,o));t.push(i)}else n.emitCampaignToSlot(e,a)})),t};n.CampaignFormats.BANNER;const R=e=>e.map((e=>{const a=e.campaign;return{campaign_id:a.campaign_id,version_id:a.version_id,slot:e.slotId[".tag"],load_method:n.LOAD_METHOD_TOOLKIT}})),U=(e={},t,c,r,p)=>a.__awaiter(void 0,void 0,void 0,(function*(){try{if(!e||!e.page&&!e.path)return[];const l=t=>a.__awaiter(void 0,void 0,void 0,(function*(){const p=[],{campaigns_result:l,campaigns_to_slots:_}=yield function(e){if(!e.campaign_properties||0===Object.keys(e.campaign_properties).length)throw new Error("campaign_properties cannot be empty");let a=new s.NoAuthApiV2Client;const t=i.getActiveUser();return void 0!==t&&(a=new n.DefaultUserApiV2Client(t)),function(e){return e.ns("campaigns_toolkit")}(a).rpc("get_best_campaigns_for_user",e,{}).catch((a=>(o.reportException({err:a,tags:["fetchCampaigns","campaigns"],severity:o.SEVERITY.NONCRITICAL,exc_extra:{args:e}}),{campaigns:[],campaigns_to_slots:{}})))}({campaign_properties:e,event_context:{file_extension:(null==c?void 0:c.file_extension)&&c.file_extension,file_name:(null==c?void 0:c.file_name)&&c.file_name,upload_error_type:(null==c?void 0:c.upload_error_type)&&c.upload_error_type,file_path:(null==c?void 0:c.file_path)&&c.file_path,file_extensions_in_directory:(null==c?void 0:c.file_extensions_in_directory)&&c.file_extensions_in_directory,page_path:null==c?void 0:c.page_path,overwrote:null==c?void 0:c.overwrote,is_video_editing_eligible:null==c?void 0:c.is_video_editing_eligible,pathway:null==c?void 0:c.pathway,source_context:null==c?void 0:c.source_context},locale:a.getPageLocale(),load_method:r,orchestration_state:t});return null==l||l.campaigns.forEach((e=>{var a,t;p.push({campaign:e,requestId:null==l?void 0:l.request_id,slotId:null!==(a=null==_?void 0:_[e.version_id])&&void 0!==a?a:{".tag":"other"},currentSequenceStep:null===(t=e.sequence)||void 0===t?void 0:t.root})})),p}));return yield t.enqueueFetch(n.LOAD_METHOD_TOOLKIT,l,R,p,e)}catch(a){o.reportException({err:a,tags:["fetchCampaigns","campaigns"],severity:o.SEVERITY.NONCRITICAL,exc_extra:{args:e}})}return[]})),F=e=>{const a={};return e.forEach((e=>{e.currentSequenceStep&&(a[e.campaign.campaign_id]=e.currentSequenceStep)})),a},G=[n.CampaignEvents.DOWNLOAD_BUTTON_CLICKED,n.CampaignEvents.FILE_SHARE_SUCCESS,n.CampaignEvents.FILE_UPLOAD_FAILURE,n.CampaignEvents.SHARE_MODAL_CLOSED,n.CampaignEvents.PAGE_LOAD,n.CampaignEvents.FILE_UPLOAD_SUCCESS,n.CampaignEvents.DELETE_SUCCESS,n.CampaignEvents.SEGMENTATION_QUIZ_COMPLETE,n.CampaignEvents.QUICK_VIEW_BROWSE_OPEN];e.CampaignsToolkit=({emitter:e=n.campaignsEmitter,loadMethod:i,shouldExpectPromptToLoad:s})=>{const[{campaigns:o,page:p,path:l,context:_,sequenceMap:g,selectiveCampaign:m,delayCampaignTimeouts:u,campaignsDisabled:d,isPreview:v},E]=t.useState({campaigns:[],page:"",path:"",context:void 0,sequenceMap:{},selectiveCampaign:void 0,delayCampaignTimeouts:[],campaignsDisabled:!1,isPreview:!1,lastSeenPreviewState:!1}),f=n.useInRouterContext()?n.useLocation():t.useMemo((()=>window.location),[]),C=f.pathname,S=f.search,h=(()=>{const[e,a]=t.useState(null);return t.useEffect((()=>{n.OrchestrationFactory.getInstance().then((e=>{a(e)}))}),[]),e})();t.useEffect((()=>{var e;const a=new URLSearchParams(S),t=!!a.get("preview")||!1,n=null!==(e=a.get("_spec_campaign"))&&void 0!==e?e:void 0;E((e=>Object.assign(Object.assign({},e),{isPreview:t,selectiveCampaign:n})))}),[S,E]),t.useEffect((()=>{let e="";e=v?c.CampaignPageName.PREVIEW:((e,a=c.CampaignPathToPageNameTree)=>{const t=e.split("/").slice(1);let n=a,i="",s=-1;for(;n;){s++;const e=t[s];if("string"==typeof n){i=n;break}if(!e||!n[e]){if(n[""]&&!e){n=n[""];continue}if(n["*"]){n=n["*"];continue}break}n=n[e]}return i})(C),n.setPageName(e),E((a=>{let t=!!c.CampaignPagesWaitForLoadEvent[e],i={page_path:C};return a.page===e&&(t=a.campaignsDisabled,a.context&&(i=Object.assign(Object.assign({},a.context),{page_path:C}))),e===c.CampaignPageName.BROWSE&&n._internalEmitRequestBrowseRefreshEvent(),null!=h&&(!a.lastSeenPreviewState&&v&&h.stashPromptShownCampaigns(),a.lastSeenPreviewState&&!v&&h.popStashedPromptShownCampaigns()),Object.assign(Object.assign({},a),{page:e,path:C,campaignsDisabled:t,context:i,lastSeenPreviewState:v})}))}),[C,v,h,E]),t.useEffect((()=>{const a=({data:{page:e,context:a},disableCampaigns:t})=>{E((n=>Object.assign(Object.assign({},n),{page:e,campaignsDisabled:t,context:a?Object.assign(Object.assign({},a),{page_path:l}):{page_path:l}}))),n.resetHistoryForEvent(n.PAGE_LOADED),n.setPageName(e)};return e.on(n.PAGE_LOADED,a),()=>{e.off(n.PAGE_LOADED,a)}}),[e,l]),t.useEffect((()=>{const a=e=>{var a;const t=[];for(const i of o){const s=null===(a=null==i?void 0:i.campaign)||void 0===a?void 0:a.campaign_id;s&&String(s)!==e?t.push(i):n.clearCampaignInSlot(i)}const i=r.cloneDeep(g);delete i[parseInt(e,10)],E((e=>Object.assign(Object.assign({},e),{campaigns:t,sequenceMap:i})))};return e.on(n.CAMPAIGN_DISMISSED,a),()=>{e.off(n.CAMPAIGN_DISMISSED,a)}}),[o,e,g]),t.useEffect((()=>{const a=({campaignId:e,ctaId:a})=>{var t,i,s;const c=parseInt(e,10),p=o.find((e=>e.campaign.campaign_id===c)),l=null==p?void 0:p.currentSequenceStep,_=null!==(i=null===(t=null==p?void 0:p.campaign.sequence)||void 0===t?void 0:t.nodes)&&void 0!==i?i:{},m={campaign:{campaign_id:c,version_id:-1,prompt_queried_at_ms:-1,campaign_name:"campaignWithOnlyCampaignId"},requestId:"",slotId:{".tag":"other"}};if(!l&&!(null==p?void 0:p.campaign.sequence))return void n.emitCampaignDismissed(e);if(!(p&&l&&a&&l in _))return n.logCampaignSequenceEvent(n.CampaignsToolkitSequenceEvents.MISSING_OR_INVALID_PARAMETERS,null!=p?p:m,l,a),void n.emitCampaignDismissed(e);const u=null===(s=_[l].children)||void 0===s?void 0:s[a];if(!u)return n.logCampaignSequenceEvent(n.CampaignsToolkitSequenceEvents.SEQUENCE_COMPLETED,p,l,a),void n.emitCampaignDismissed(e);const d=Object.assign(Object.assign({},p),{currentSequenceStep:u}),v=o.map((e=>e.campaign.campaign_id===c?d:e)),f=r.cloneDeep(g);f[c]=u,E((e=>Object.assign(Object.assign({},e),{campaigns:v,sequenceMap:f}))),n.logCampaignSequenceEvent(n.CampaignsToolkitSequenceEvents.PROGRESS_SEQUENCE,p,u,a),n.emitCampaignToSlot(d)};return e.on(n.CAMPAIGN_SEQUENCE_ACTION,a),()=>{e.off(n.CAMPAIGN_SEQUENCE_ACTION,a)}}),[o,g,e]);const O=t.useCallback(((e,t,n,o)=>a.__awaiter(void 0,void 0,void 0,(function*(){return U({page:e,action:o||void 0,selective_campaign:m||void 0,path:l},t,n,i,s)}))),[i,m,s,l]);t.useEffect((()=>{const t=({name:e,data:{context:t,loggingParams:i}={}})=>a.__awaiter(void 0,void 0,void 0,(function*(){if(!G.includes(e))return;if(null==h)return;L(u);const a=yield O(p,h,t,e),i=F(a);E((e=>e.page!==p?e:Object.assign(Object.assign({},e),{campaigns:r.uniqBy([...e.campaigns,...a].reverse(),n.getSlotFromCampaignFormatProps),sequenceMap:Object.assign(Object.assign({},e.sequenceMap),i),delayCampaignTimeouts:M(a,t)})))}));return e.on(n.CAMPAIGN_EVENT,t),()=>{e.off(n.CAMPAIGN_EVENT,t)}}),[p,O,u,e]);const[I,b]=t.useState({page:"",path:"",campaignsDisabled:!1});return t.useEffect((()=>{if(I.page===p&&(I.path===l||""!==p)&&I.campaignsDisabled===d)return;if(null==h)return;if(b({page:p,path:l,campaignsDisabled:d}),h.clearToolkitCampaignsFromState(),n.emitClearAllCampaignsFromSlots(),!p&&!l||d)return void E((e=>(L(e.delayCampaignTimeouts),Object.assign(Object.assign({},r.omit(e,"context")),{campaigns:[],sequenceMap:{},delayCampaignTimeouts:[]}))));a.__awaiter(void 0,void 0,void 0,(function*(){const e=yield O(p,h,_),a=F(e);E((t=>t.page!==p||t.path!==l&&""===p?t:(L(t.delayCampaignTimeouts),Object.assign(Object.assign({},r.omit(t,"context")),{campaigns:e,sequenceMap:a,delayCampaignTimeouts:M(e,_)}))))}))}),[p,l,d,_,h,O,I]),N.default.createElement(q,null)},e.fetchCampaigns=U}));
//# sourceMappingURL=c_campaigns_campaigns_toolkit_client.js-vfl7ePZG_.map
