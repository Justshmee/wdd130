define(["exports","./e_folder_viewer_src_main","./c_init_data_runtime","./c_toolkit_dist_redux-toolkit","./c_browse_data_selectors","./c_sharing_avatar_info","./c_react_query_helpers_helpers","./c_files_view_data_store"],(function(e,a,t,r,s,i,n,d){"use strict";const o={sharedFolderDataByTargetNamespaceId:{},hasSharedDataLoadedByParentPath:{},sharedLinkExistsByFileIdOrPath:{},sharedFileDataByFileId:{},integrationData:void 0},l=(e,t,r)=>{return s="/share_ajax/shared_with",i={max_results:r,fq_path_prefix:t,include_inherited:!0,sort_by_name:!0},n=!1,d=e,o=!0,new Promise(((e,t)=>{(n?a.SilentBackgroundRequest:a.WebRequest)({url:s,type:"POST",dataType:"json",data:i,subject_user:d,skipNotifyError:o,success:e,error:(e,a,r)=>t(Error(`error: ${r}, status: ${a}`))})}));var s,i,n,d,o};function _(e,a){return["share_ajax:shared_with",e,a.toString()]}const h=e=>s.user(e),u=e=>a=>{a(g.setHasSharedDataLoaded({path:e,isLoaded:!1})),a(p({parentPath:e,abortCurrentRequest:!0}))};let c=null;const p=({parentPath:e,abortCurrentRequest:a=!1})=>(t,r)=>{const i=r();a&&c&&c.abort(),s.isInsideBackupFolder(i)?t(S({parentPath:e})):t(m({parentPath:e}))},S=({parentPath:e})=>(t,r)=>{const i=r(),n=h(i),d=s.mountPoints(i),o={};d&&d.forEach(((e,t)=>o[t]={memberCount:1,joinedMembers:[Object.assign(Object.assign({},n),{access_type:"owner",user_id:n.id,photo_url:n.photo_url,initials:a.getInitials(n.display_name)})]})),t(g.setNamespaceSharedWithData({parentPath:e,sharedFolderData:o}))},m=r.createAsyncThunk(`${a.BROWSE_SHARED_WITH_NAMESPACE_KEY}/fetchSharedWithData`,(({parentPath:e},{getState:a})=>t.__awaiter(void 0,void 0,void 0,(function*(){const r=a(),s=h(r);return yield n.queryClient.fetchQuery(_(e,5),(()=>t.__awaiter(void 0,void 0,void 0,(function*(){return yield l(s,e,5).then((a=>{const t=(e=>{const a={};for(const t of e)a[t.ns_id]={numUndisplayableUsersAndInvites:t.num_avatars_not_shown,groups:t.groups,invitations:t.invitations,joinedMembers:t.joined_members,audienceDescription:t.audience_description,memberCount:t.num_users_and_invites,accessTextData:{total_groups_and_users:t.total_groups_and_users,total_unique_inherited_members:t.total_unique_inherited_members,total_unique_users:t.total_unique_users,users_outside_team:t.users_outside_team,is_confidential:t.is_confidential,isParentTmr:t.is_parent_tmr,is_parent_tsd:t.is_parent_tsd,is_parent_namespace:t.is_parent_namespace,has_team_group:t.has_team_group,has_group:t.has_group}};return a})(a);return{sharedFolderData:t,parentPath:e}})).finally((()=>c=null))}))))})))),y=()=>e=>{e(g.clearSharedFileDataByFileId(null)),e(f())},f=()=>(e,t)=>{const r=t(),i=(e=>a.getStateAtNamespace(e,a.BROWSE_SHARED_WITH_NAMESPACE_KEY)||o)(r),n=s.sortedFiles(r).reduce(((e,a)=>((e=>!(e.is_dir||e.isDeleted))(a)&&!(a.file_id in i.sharedFileDataByFileId)&&e.push(a.file_id),e)),[]);e(D(n))},D=r.createAsyncThunk(`${a.BROWSE_SHARED_WITH_NAMESPACE_KEY}/fetchSharedFileDataForFiles`,((e,{getState:r,dispatch:s,rejectWithValue:n})=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=r(),d=h(t);if(!d.is_email_verified)return n("User's email is not verified.");const o=e.slice(0,100),l=e.slice(100);return yield((e,t,r)=>new a.FileShareApiClient({userId:r.id}).listMembersBatch({contentIds:e,limit:t}))(o,5,d).then((e=>{const a={};return e.forEach(((e,t)=>{a[t]={numUndisplayableUsersAndInvites:0,groups:e.groups.valueSeq().map(i.apiGroupMemberToAvatarInfo).toArray(),invitations:e.invitees.valueSeq().map(i.apiInviteeMemberToAvatarInfo).toArray(),joinedMembers:e.users.valueSeq().map(i.apiUserMemberToAvatarInfo).toArray()}})),(null==l?void 0:l.length)&&s(D(l)),{sharedFileData:a}}))})))),E=r.createAsyncThunk(`${a.BROWSE_SHARED_WITH_NAMESPACE_KEY}/fetchSharedLinkExists`,((e,{getState:r})=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=r(),i=s.user(t);return yield((e,t)=>new a.FileShareApiClient({userId:t.id}).sharedLinkInfo({fileIdOrPath:e}))(e,i).then((a=>({fileIdOrPath:e,sharedLinkExists:(null==a?void 0:a.length)>0})))})))),F=r.createSlice({name:a.BROWSE_SHARED_WITH_NAMESPACE_KEY,initialState:o,reducers:{clear:(e,a)=>o,clearSharedFileDataByFileId:(e,a)=>{e.sharedFileDataByFileId={}},clearSharedLinkExistsCache:(e,a)=>{e.sharedLinkExistsByFileIdOrPath={}},setHasSharedDataLoaded:(e,a)=>{const{payload:t}=a;e.hasSharedDataLoadedByParentPath[t.parentPath]=t.isLoaded},setNamespaceSharedWithData:(e,a)=>{const{payload:t}=a;e.hasSharedDataLoadedByParentPath[t.parentPath]=!0,e.sharedFolderDataByTargetNamespaceId=t.sharedFolderData}},extraReducers:e=>{e.addCase(m.fulfilled,((e,{payload:a})=>{const t=Object.assign({},e.hasSharedDataLoadedByParentPath);return t[a.parentPath]=!0,Object.assign(Object.assign({},e),{hasSharedDataLoadedByParentPath:t,sharedFolderDataByTargetNamespaceId:a.sharedFolderData})})).addCase(D.fulfilled,((e,{payload:a})=>Object.assign(Object.assign({},e),{sharedFileDataByFileId:Object.assign(Object.assign({},e.sharedFileDataByFileId),a.sharedFileData)}))).addCase(E.fulfilled,((e,a)=>{e.sharedLinkExistsByFileIdOrPath[a.payload.fileIdOrPath]=a.payload.sharedLinkExists}))}}),{reducer:P}=F,g=F.actions;let v;e.filesChanged=e=>(a,t)=>{const r=t();e===s.path(r)&&(a(g.clearSharedLinkExistsCache(null)),a(E(e)),n.queryClient.invalidateQueries(_(e,5)),a(p({parentPath:e})),a(g.clearSharedFileDataByFileId(null)),a(f()))},e.getStoreForSharedWith=()=>(v||(v=a.getStoreAndRegisterReducers({[a.BROWSE_SHARED_WITH_NAMESPACE_KEY]:P})),d.getStoreForBrowse(),v),e.pathLoaded=({path:e})=>a=>{a(E(e)),a(u(e)),a(y())},e.sharedFileDataOutOfDate=e=>a=>{a(D(e))},e.sharedFolderDataOutOfDate=e=>(a,t)=>{if(!e){const a=t();e=s.path(a)}n.queryClient.invalidateQueries(_(e,5)),a(p({parentPath:e}))},e.sharedLinkDataOutOfDate=e=>a=>{e&&a(E(e))}}));
//# sourceMappingURL=c_shared_with_redux_store.js-vflGSxH1A.map
