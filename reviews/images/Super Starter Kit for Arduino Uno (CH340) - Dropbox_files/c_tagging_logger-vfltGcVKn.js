define(["require","exports","./c_init_data_runtime","./e_folder_viewer_src_main","./c_files_view_data_store","./c_browse_models"],(function(i,e,t,n,a,_){"use strict";function r(i){return i.ns("manual_tagging")}function o(i){const e=a.getFileObjectNsIdAndPath(i);return{ns_id:e.nsId,ns_path:e.nsPath}}const s=i=>new Promise((e=>setTimeout(e,i)));const d=new class{getTags(i,e){return t.__awaiter(this,void 0,void 0,(function*(){const t=new n.DefaultUserApiV2Client(i),_={content_ids:e.map(o)};return(yield r(t).rpc("tags/get",_,{})).tags_by_content_id.reduce(((i,{content_id:{ns_id:e,ns_path:t},tags:n,typed_tags:_})=>(i[a.getFileObjectNsIdAndPathKey({nsId:e,nsPath:t})]=((i,e)=>e?e.filter(a.isTextTag):i.map((i=>({".tag":"user_generated_tag",tag_text:i}))))(n,_),i)),{})}))}getAllTags(i){return t.__awaiter(this,void 0,void 0,(function*(){const e=new n.DefaultUserApiV2Client(i);return(yield r(e).rpc("tags/get_viewable_tags",void 0,{})).tag_and_counts.map((i=>i.typed_tag)).filter(a.isTextTag)}))}addTag(i,e,a){return t.__awaiter(this,void 0,void 0,(function*(){const t=new n.DefaultUserApiV2Client(i),_={tag:e,content_id:o(a)};return(yield r(t).rpc("tag/add",_,{})).hlc}))}addTagBulk(i,e,a){return t.__awaiter(this,void 0,void 0,(function*(){const _=new n.DefaultUserApiV2Client(i),d={tag:e,content_ids:a.map(o)},l=yield r(_).rpc("tag/add_bulk",d,{});if("complete"===l[".tag"])return l.failed;if("failed"===l[".tag"])throw new Error("tag/add_bulk failed");const{async_job_id:c}=l,f=()=>t.__awaiter(this,void 0,void 0,(function*(){return yield r(_).rpc("tag/add_bulk/check",{async_job_id:c},{})}));let g=yield f();for(;"in_progress"===g[".tag"];)yield s(1e3),g=yield f();if("failed"===g[".tag"]||"other"===g[".tag"])throw new Error("tag/add_bulk failed");return g.failed}))}removeTag(i,e,a){return t.__awaiter(this,void 0,void 0,(function*(){const t=new n.DefaultUserApiV2Client(i),_={tag:e,content_id:o(a)};return(yield r(t).rpc("tag/remove",_,{})).hlc}))}removeTagBulk(i,e,a){return t.__awaiter(this,void 0,void 0,(function*(){const _=new n.DefaultUserApiV2Client(i),d={tag:e,content_ids:a.map(o)},l=yield r(_).rpc("tag/remove_bulk",d,{});if("complete"===l[".tag"])return l.failed;if("failed"===l[".tag"])throw new Error("tag/remove_bulk failed");const{async_job_id:c}=l,f=()=>t.__awaiter(this,void 0,void 0,(function*(){return yield r(_).rpc("tag/remove_bulk/check",{async_job_id:c},{})}));let g=yield f();for(;"in_progress"===g[".tag"];)yield s(1e3),g=yield f();if("failed"===g[".tag"]||"other"===g[".tag"])throw new Error("tag/remove_bulk failed");return g.failed}))}listFolder(i,e){var a,r;return t.__awaiter(this,void 0,void 0,(function*(){try{"/"===i&&(i="");const t={fq_path:i,include_deleted:!1,sort_is_ascending:!1,sort_folders_first:!1,include_xattrs:!1,include_folder_overview:!1};let o=!1;const s=[],d=new n.DefaultUserApiV2Client(e);let l=yield n.GetFilesRoutes(d).rpc("browse",t,{});for(null===(a=l.paginated_file_info)||void 0===a||a.forEach((i=>i.file_info&&s.push(i.file_info)));l.has_more;){if(s.length>700){o=!0;break}l=yield n.GetFilesRoutes(d).rpc("browse_continue",{cursor:l.next_request_voucher},{}),null===(r=l.paginated_file_info)||void 0===r||r.forEach((i=>i.file_info&&s.push(i.file_info)))}return{files:s.map((i=>_.File.fromAnyFileObject(i))),reachedLimit:o}}catch(i){throw new Error("list_folder API error")}}))}};class l{constructor(i){this.category="server-tag_actions",this.file_oid=0,this.session_id=null,this.team_id=null,this.user_id=i.user_id,this.tag_name=i.tag_name,this.tag_type=i.tag_type,this.platform=i.platform,this.event_name=i.event_name,this.file_ext=i.file_ext,this.file_nsid=i.file_nsid,this.file_sjid=i.file_sjid,i.hasOwnProperty("file_oid")&&void 0!==i.file_oid&&(this.file_oid=i.file_oid),this.action_surface=i.action_surface,i.hasOwnProperty("session_id")&&void 0!==i.session_id&&(this.session_id=i.session_id),i.hasOwnProperty("team_id")&&void 0!==i.team_id&&(this.team_id=i.team_id),i.hasOwnProperty("snackbar_action")&&void 0!==i.snackbar_action&&(this.snackbar_action=i.snackbar_action),i.hasOwnProperty("tagging_type")&&void 0!==i.tagging_type&&(this.tagging_type=i.tagging_type),i.hasOwnProperty("script_in_tag")&&void 0!==i.script_in_tag&&(this.script_in_tag=i.script_in_tag),this.file_id=i.file_id,Object.seal(this)}}const c="web",f=new n.HiveLogger;function g(e){return t.__awaiter(this,void 0,void 0,(function*(){const{LOGGING_ALLOWED_EXTS:t,LOGGING_UNALLOWED_EXT_PLACEHOLDER:n}=yield new Promise((function(e,t){i(["./e_folder_viewer_src_main"],e,t)})).then((function(i){return i.extension_constants_esnext}));return t.includes(e.ext)?e.ext:n}))}e.createContentIdFromFile=o,e.logAddTag=function(i,e,n,a){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){f.log(new l({tag_name:null,tag_type:"user_generated_tag",event_name:"add_tag",action_surface:a,file_ext:yield g(e),file_nsid:e.ns_id.toString(),file_sjid:e.sjid.toString(),platform:c,user_id:i.id,file_id:e.file_id,script_in_tag:/[^a-zA-Z0-9_]/iu.test(n)}))})))))}))},e.logRemoveTag=function(i,e,n,_){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){f.log(new l({tag_name:null,tag_type:a.getTagType(n),event_name:"remove_tag",action_surface:_,file_ext:yield g(e),file_nsid:e.ns_id.toString(),file_sjid:e.sjid.toString(),platform:c,user_id:i.id,file_id:e.file_id,script_in_tag:/[^a-zA-Z0-9_]/iu.test(n.tag_text)}))})))))}))},e.logSelectTagBar=function(i,e,n){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){f.log(new l({tag_name:null,tag_type:"na",event_name:"select_tag_bar",action_surface:n,file_ext:yield g(e),file_nsid:e.ns_id.toString(),file_sjid:e.sjid.toString(),platform:c,user_id:i.id,file_id:e.file_id}))})))))}))},e.logStartTypingTag=function(i,e,n){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){f.log(new l({tag_name:null,tag_type:"na",event_name:"start_typing_tag",action_surface:n,file_ext:yield g(e),file_nsid:e.ns_id.toString(),file_sjid:e.sjid.toString(),platform:c,user_id:i.id,file_id:e.file_id}))})))))}))},e.logTagClick=function(i,e,n,_){return t.__awaiter(this,void 0,void 0,(function*(){yield Promise.all(e.map((e=>t.__awaiter(this,void 0,void 0,(function*(){f.log(new l({tag_name:null,tag_type:a.getTagType(_),event_name:"select_tag",action_surface:n,file_ext:yield g(e),file_nsid:e.ns_id.toString(),file_sjid:e.sjid.toString(),platform:c,user_id:i.id,file_id:e.file_id,script_in_tag:/[^a-zA-Z0-9_]/iu.test(_.tag_text)}))})))))}))},e.tagsApiClient=d}));
//# sourceMappingURL=c_tagging_logger.js-vflryJ7Bd.map
