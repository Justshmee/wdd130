define(["exports","./c_init_data_runtime","./c_core_uri","./c_core_attribution_header","./c_csrf"],(function(e,t,s,n,o){"use strict";var r,i,a;e.ApiV2HeaderNames=void 0,(r=e.ApiV2HeaderNames||(e.ApiV2HeaderNames={})).DropboxApiArg="Dropbox-API-Arg",r.DropboxApiSelectAdmin="Dropbox-API-Select-Admin",r.DropboxPathRoot="X-Dropbox-Path-Root",r.DropboxUid="X-Dropbox-Uid",r.DropboxTeamId="X-Dropbox-Teamid",r.DropboxTeamAuthorization="X-Dropbox-Team-Authorization",r.CsrfToken="X-CSRF-Token",r.DropboxForceQuic="X-Dropbox-Force-Quic",function(e){e[e.TeamAdminRole=0]="TeamAdminRole",e[e.MTARole=1]="MTARole",e[e.FederationAdminRole=2]="FederationAdminRole"}(i||(i={})),function(e){e[e.AdminAction=0]="AdminAction",e[e.AssumeAction=1]="AssumeAction",e[e.OnBehalfOfAction=2]="OnBehalfOfAction"}(a||(a={}));class d{static parse(e){const t=e[".tag"];return 2===Object.keys(e).length&&null!=e[t]?new c(t,e[t]):new p(t,e)}constructor(e,t,s){this.type=e,this.value=t,this.isScalar=s}}class c extends d{constructor(e,t=null){super(e,t,!0)}toJSON(){const e={".tag":this.type};return null!=this.value&&(e[this.type]=this.value),e}}class p extends d{constructor(e,t={}){super(e,t,!1)}toJSON(){return Object.assign({".tag":this.type},this.value||{})}}class u extends Error{static parseResponse(e,t,s,n=null){let o="";null==n&&(n=e in b?b[e]:e>=500?h:u);const r={raw:{status:e,responseBody:s},summary:null,error:{},headers:t};try{const e=JSON.parse(s)||{};r.error=e.error,r.summary=e.error_summary,o=null!=e.user_message?e.user_message.text:""}catch(e){}return Object.assign(new n(o||void 0),r)}}class l extends u{}class h extends u{}class m extends u{}function f(e){return e instanceof u}const b={400:class extends u{},401:class extends u{},409:l,429:m};class w extends Error{constructor(e,t){super(t),this.name="FetchAbortError",this.response=e}}class _ extends Error{constructor(e,t){super(t),this.name="FetchFailError",this.response=e}}class g extends Error{constructor(e,t){super(t),this.name="FetchResponseError",this.response=e}}function x(e){return"FetchResponseError"===e.name}const T={idleTimeout:500,networkTimeout:6e4};class E{constructor(){this.pendingRequests=0,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{this.didNetworkTimeOut=!0,this.pendingRequests=0,this.next("IDLE")}),T.networkTimeout)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.increment=()=>{this.startCleanupTimeout(),0===this.pendingRequests&&this.next("BUSY"),this.pendingRequests+=1},this.decrement=()=>{this.abortCleanupTimeout(),1===this.pendingRequests?this.next("IDLE"):this.startCleanupTimeout(),this.pendingRequests=Math.max(this.pendingRequests-1,0)},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}}}}class A{constructor(){this.pendingResources=new Set,this.subscribers=new Set,this.didNetworkTimeOut=!1,this.next=e=>{this.subscribers.forEach((t=>t(e)))},this.startCleanupTimeout=()=>{this.abortCleanupTimeout();this.cleanupTimeout=window.setTimeout((()=>{this.didNetworkTimeOut=!0,this.pendingResources=new Set,this.next("IDLE")}),T.networkTimeout)},this.abortCleanupTimeout=()=>{window.clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0},this.add=e=>{e instanceof HTMLImageElement&&!e.src||e instanceof HTMLImageElement&&e.complete||e instanceof HTMLLinkElement&&!e.href||e instanceof HTMLScriptElement&&!e.src||e instanceof HTMLIFrameElement&&!e.src||(this.startCleanupTimeout(),0===this.pendingResources.size&&this.next("BUSY"),this.pendingResources.add(e))},this.remove=e=>{this.abortCleanupTimeout(),this.pendingResources.delete(e),0===this.pendingResources.size?this.next("IDLE"):this.startCleanupTimeout()},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},(null===window||void 0===window?void 0:window.MutationObserver)&&window.addEventListener("load",(()=>{new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.forEach((e=>{e instanceof HTMLScriptElement||e instanceof HTMLLinkElement||e instanceof HTMLImageElement||e instanceof HTMLIFrameElement?this.add(e):e.hasChildNodes()&&e instanceof HTMLElement&&e.querySelectorAll("img").forEach(this.add)}))}))})).observe(window.document.documentElement,{childList:!0,subtree:!0}),["load","error"].forEach((e=>{window.document.addEventListener(e,(e=>{(e.target instanceof HTMLScriptElement||e.target instanceof HTMLLinkElement||e.target instanceof HTMLImageElement||e.target instanceof HTMLIFrameElement)&&this.remove(e.target)}),{capture:!0})}))}))}}class R{constructor(){this.incrementAjaxCount=()=>{},this.decrementAjaxCount=()=>{},this.isIdle=()=>!0,this.didNetworkTimeOut=()=>!1,this.resetDidNetworkTimeOut=()=>{},this.subscribe=()=>()=>{}}}class O{constructor(){this.ajaxIdleObservable=new E,this.resourceLoadingIdleObservable=new A,this.subscribers=new Set,this.ajaxIdle=!0,this.scriptLoadingIdle=!0,this.handleUpdate=e=>t=>{const s=this.ajaxIdle&&this.scriptLoadingIdle;"AJAX"===e&&(this.ajaxIdle="IDLE"===t),"RESOURCE_LOADING"===e&&(this.scriptLoadingIdle="IDLE"===t);const n=this.ajaxIdle&&this.scriptLoadingIdle;s!==n&&this.next(n?"IDLE":"BUSY")},this.next=e=>{this.subscribers.forEach((t=>t(e)))},this.incrementAjaxCount=()=>this.ajaxIdleObservable.increment(),this.decrementAjaxCount=()=>this.ajaxIdleObservable.decrement(),this.isIdle=()=>this.ajaxIdle&&this.scriptLoadingIdle,this.didNetworkTimeOut=()=>this.ajaxIdleObservable.didNetworkTimeOut||this.resourceLoadingIdleObservable.didNetworkTimeOut,this.resetDidNetworkTimeOut=()=>{this.ajaxIdleObservable.didNetworkTimeOut=!1,this.resourceLoadingIdleObservable.didNetworkTimeOut=!1},this.subscribe=e=>{this.subscribers.add(e);return()=>{this.subscribers.delete(e)}},this.ajaxIdleObservable.subscribe(this.handleUpdate("AJAX")),this.resourceLoadingIdleObservable.subscribe(this.handleUpdate("RESOURCE_LOADING"))}}let v;const k=()=>"boolean"==typeof RUNNING_IN_REACTSERVER||"undefined"==typeof window?new R:(v||(v=new O),v),I=k().incrementAjaxCount,y=k().decrementAjaxCount;function C(e){const t={};return e.forEach(((e,s)=>{t[s]=e})),t}class j{executeRpc(e,t,n,o,r){return new Promise(((i,a)=>{s.incrementAjaxCount(),I();const d=()=>{s.decrementAjaxCount(),y()};return fetch(e.toString(),{method:"POST",mode:"same-origin",credentials:"same-origin",headers:Object.assign(Object.assign({},t),{"Content-Type":o}),body:n,signal:r}).then((e=>e.text().then((t=>({response:e,responseText:t}))))).then((({response:e,responseText:t})=>{if(e.ok)return{response:e,responseText:t};throw new g(e,t)})).then((({response:e,responseText:t})=>(d(),i({headers:C(e.headers),result:JSON.parse(t)})))).catch((e=>(d(),x(e)?a(u.parseResponse(e.response.status,C(e.response.headers),e.message)):a(u.parseResponse(0,{},"")))))}))}executeBinaryRpc(e,t,n,o,r){return new Promise(((i,a)=>(s.incrementAjaxCount(),I(),fetch(e.toString(),{method:"POST",mode:"same-origin",credentials:"same-origin",headers:Object.assign(Object.assign({},t),{"Content-Type":o}),body:n,signal:r}).then((e=>e.ok?e.arrayBuffer().then((t=>({response:e,responseData:t}))):e.text().then((t=>{throw new g(e,t)})))).then((({response:e,responseData:t})=>i({headers:C(e.headers),result:t}))).catch((e=>x(e)?a(u.parseResponse(e.response.status,C(e.response.headers),e.message)):a(u.parseResponse(0,{},"")))).finally((()=>{s.decrementAjaxCount(),y()})))))}}class S extends j{}function H(e){const t=this;return{rpc:function(s,n,o){return t._rpc(e+"/"+s,n,o)},rpcWithResponseHeaders:function(s,n,o){return t._rpcWithResponseHeaders(e+"/"+s,n,o)},upload:function(s,n,o,r){return t._upload(e+"/"+s,n,o,r)},uploadWithResponseHeaders:function(s,n,o,r){return t._uploadWithResponseHeaders(e+"/"+s,n,o,r)},download:function(s,n,o,r){return t._download(e+"/"+s,n,o,r)},downloadWithResponseHeaders:function(s,n,o,r){return t._downloadWithResponseHeaders(e+"/"+s,n,o,r)}}}e.ApiError=u,e.ApiV2ClientBase=class{constructor(e){this.uploadEndpoints=new Set(["backups/upload_session/append","files/alpha/upload","files/paper/create","files/paper/update","files/upload","files/upload_v2","files/upload_session/append_v2","files/upload_session/append_batch","files/upload_session/finish","files/upload_session/finish_v2","files/upload_session/start","paper/cloud_docs/update","paper/desktop/spaces/upload_log","paper/desktop/upload_log","paper/docs/create","paper/docs/update","support_attachments/upload","hellosign/self_sign","hellosign/send_signature_request","hellosign/create_template","ungated_file_conv_block/convert_to_pdf"]),this.downloadEndpoints=new Set(["backups/download","backups/download_zip","files/download","files/download_zip","files/export","files/get_preview","files/get_thumbnail_v2","paper/docs/download","sharing/get_shared_link_file","sharing/export_shared_link","hellosign/convert_to_pdf_download"]),this.supportedUploadEndpoints=new Set(["backups/upload_session/append","files/paper/create","files/paper/update","files/upload","files/upload_v2","files/upload_session/append_v2","files/upload_session/append_batch","files/upload_session/finish","files/upload_session/finish_v2","files/upload_session/start","paper/cloud_docs/update","paper/desktop/spaces/upload_log","paper/desktop/upload_log","paper/docs/create","paper/docs/update","support_attachments/upload","hellosign/self_sign","hellosign/send_signature_request","hellosign/create_template","ungated_file_conv_block/convert_to_pdf"]),this.supportedDownloadEndpoints=new Set(["backups/download","backups/download_zip","files/download","files/get_thumbnail_v2","sharing/get_shared_link_file","sharing/export_shared_link","hellosign/convert_to_pdf_download"]),this.transport=e||new S,this.ns=H.bind(this)}_upload(e,t,s,n){return this._uploadWithResponseHeaders(e,t,s,n).then((e=>e.result))}_uploadWithResponseHeaders(s,n,o,r){if(!this.uploadEndpoints.has(s))throw new Error(s+" does not use the content-upload endpoint format");if(!this.supportedUploadEndpoints.has(s))throw new Error(s+" is not in the supported list of content-upload endpoints");const i=Object.assign({[e.ApiV2HeaderNames.CsrfToken]:this.csrfToken(),[e.ApiV2HeaderNames.DropboxApiArg]:this.http_header_safe_json(n)},this._headers(r));if(Boolean(t.isHTTP3SupportEnabled())&&(i[e.ApiV2HeaderNames.DropboxForceQuic]="true"),"string"==typeof o||void 0===o)return this.executeRpc(s,i,o||"","application/octet-stream",r.signal);{const e=new Blob([o],{type:"application/octet-stream"});return this.executeRpc(s,i,e,"application/octet-stream",r.signal)}}_download(e,t,s,n){return this._downloadWithResponseHeaders(e,t,s,n).then((e=>e.result))}_downloadWithResponseHeaders(s,n,o,r){if(void 0===r||!r.hasOwnProperty("dangerouslyFetchUserContent")||!r.dangerouslyFetchUserContent)throw new Error("download requires explicit acknowledgement of the risk");if(!this.downloadEndpoints.has(s))throw new Error(s+" does not use the content-download endpoint format");if(!this.supportedDownloadEndpoints.has(s))throw new Error(s+" is not in the supported list of content-download endpoints");const i=Object.assign({[e.ApiV2HeaderNames.CsrfToken]:this.csrfToken(),[e.ApiV2HeaderNames.DropboxApiArg]:this.http_header_safe_json(n)},this._headers(o));return Boolean(t.isHTTP3SupportEnabled())&&(i[e.ApiV2HeaderNames.DropboxForceQuic]="true"),this.executeBinaryRpc(s,i,"","application/octet-stream",o.signal)}_rpc(e,t,s){return this._rpcWithResponseHeaders(e,t,s).then((e=>e.result))}_rpcWithResponseHeaders(s,n,o){const r=Object.assign({[e.ApiV2HeaderNames.CsrfToken]:this.csrfToken()},this._headers(o));if(Boolean(t.isHTTP3SupportEnabled())&&(r[e.ApiV2HeaderNames.DropboxForceQuic]="true"),this.downloadEndpoints.has(s))throw new Error(s+' does not use the rpc endpoint format. Use "download" instead');if(this.uploadEndpoints.has(s))throw new Error(s+' does not use the rpc endpoint format. Use "upload" instead');const i=JSON.stringify(n||null);return this.executeRpc(s,r,i,"application/json",o.signal)}csrfToken(){return o.Cookies.read("__Host-js_csrf")||""}executeRpc(e,o,r,i,a){return t.__awaiter(this,void 0,void 0,(function*(){const t="client-web.dropbox.com"===window.location.hostname?"client-web.dropbox.com":"www.dropbox.com";const d=n.getAttributionHeader();d&&(o["x-dropbox-client-yaps-attribution"]=d);const c=new s.URI({scheme:"https",authority:t,path:"/2/"+e,query:undefined});return yield this.transport.executeRpc(c,o,r,i,a)}))}executeBinaryRpc(e,n,o,r,i){return t.__awaiter(this,void 0,void 0,(function*(){const t="client-web.dropbox.com"===window.location.hostname?"client-web.dropbox.com":"www.dropbox.com";const a=new s.URI({scheme:"https",authority:t,path:"/2/"+e,query:undefined});return yield this.transport.executeBinaryRpc(a,n,o,r,i)}))}http_header_safe_json(e){return JSON.stringify(e).replace(/[\u007f-\uffff]/g,(function(e){return"\\u"+("000"+e.charCodeAt(0).toString(16)).slice(-4)}))}},e.AppError=l,e.CONFIG=T,e.FetchAbortError=w,e.FetchAsyncTransport=j,e.FetchFailError=_,e.FetchResponseError=g,e.FetchSyncTransport=class{executeRpc(e,t,n,o,r){return s.incrementAjaxCount(),I(),fetch(e.toString(),{method:"POST",mode:"same-origin",credentials:"same-origin",headers:Object.assign(Object.assign({},t),{"Content-Type":o}),keepalive:!0,body:n,signal:r}).finally((()=>{s.decrementAjaxCount(),y()})),Promise.resolve({headers:{},result:{}})}executeBinaryRpc(e,t,n,o,r){return s.incrementAjaxCount(),I(),fetch(e.toString(),{method:"POST",mode:"same-origin",credentials:"same-origin",headers:Object.assign(Object.assign({},t),{"Content-Type":o}),keepalive:!0,body:n,signal:r}).finally((()=>{s.decrementAjaxCount(),y()})),Promise.resolve({headers:{},result:new ArrayBuffer(0)})}},e.RateLimitError=m,e.ServerError=h,e.Union=d,e.UnionScalar=c,e.catchApiError=function(e){return function(t){if(f(t))return e(t);throw t}},e.decrementAjaxCount=y,e.errorIsFetchAbortError=function(e){return"FetchAbortError"===e.name},e.errorIsFetchFailError=function(e){return"FetchFailError"===e.name},e.errorIsFetchResponseError=x,e.filterApiError=e=>e instanceof u?e:void 0,e.getNetworkIdleObservable=k,e.incrementAjaxCount=I,e.isApiError=f,e.isAppError=function(e){return e instanceof l}}));
//# sourceMappingURL=c_api_v2_client_base.js-vfl7mfWn3.map
